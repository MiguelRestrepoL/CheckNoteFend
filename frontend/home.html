<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CheckNote</title>
    <link rel="stylesheet" href="./GlobalCSS2.css">
</head>
<body>
    <div class="page-root">
        <!-- TOPBAR -->
        <header class="topbar">
            <div class="topbar-left">
                <a href="sobrenosotros.html" style="display: flex; align-items: center; text-decoration: none;">
                    <div class="logo size-md">
                        <img src="/logoo.svg" alt="CheckNote logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiByeD0iOCIgZmlsbD0iIzEwYjk4MSIvPgo8c3ZnIHg9IjE2IiB5PSIxNiIgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IndoaXRlIj4KPHBhdGggZD0iTTkgMTJMMTEgMTRMMjIgM00yMSAxMlYxOUEyIDIgMCAwIDEgMTkgMjFINUEyIDIgMCAwIDEgMyAxOVY1QTIgMiAwIDAgMSA1IDNIMTYiLz4KPC9zdmc+Cjwvc3ZnPgo='" />
                    </div>
                </a>
            </div>

            <div class="topbar-center">
                <div class="search-wrap">
                    <img src="/search.png" alt="buscar" class="search-icon" />
                    <input class="search-input" placeholder="Buscar tareas..." />
                </div>
            </div>

            <div class="topbar-right">
                <a href="perfil.html" style="display: flex; align-items: center; gap: 8px; text-decoration: none;">
                    <img src="/usuario.png" alt="usuario" class="icon user-icon" />
                    <span class="username" id="username">Usuario</span>
                </a>
            </div>
        </header>

        <!-- MAIN -->
        <main class="main">
            <div class="center-column">
                <!-- Mensaje de √©xito -->
                <div id="success-message" class="success-message hidden"></div>

                <!-- Mensaje de error -->
                <div id="error-message" class="error-message hidden">
                    <div class="error-title">‚ö†Ô∏è Error de Conexi√≥n</div>
                    <div id="error-text"></div>
                    <div class="error-buttons">
                        <button id="retry-btn" class="error-btn retry">üîÑ Reintentar</button>
                        <button id="new-login-btn" class="error-btn login">üö™ Nuevo Login</button>
                    </div>
                </div>

                <!-- Debug info -->
                <div id="debug-info" class="debug-info hidden">
                    <strong>DEBUG INFO:</strong><br />
                    <span id="debug-token">Token: </span><br />
                    <span id="debug-tasks">Total tareas: </span>
                </div>

                <!-- Tarjeta de progreso -->
                <section class="task-card">
                    <h3 class="task-title">Panel de Tareas</h3>
                    <p class="task-sub" id="task-subtitle">Cargando tus tareas...</p>

                    <div class="progress-wrap">
                        <div class="progress-bar">
                            <div class="progress" id="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="progress-info">
                        <span id="progress-percentage">0% completado</span>
                        <span id="progress-tasks">0 de 0 tareas ‚úÖ</span>
                    </div>
                </section>

                <!-- Layout Kanban -->
                <div class="kanban-container">
                    <!-- Columna Pendientes -->
                    <div class="kanban-column">
                        <div class="kanban-header">
                            <span class="kanban-icon">‚è∞</span>
                            <h4 class="kanban-title">Tareas pendientes (<span id="pendientes-count">0</span>)</h4>
                        </div>
                        <div class="kanban-tasks" id="pendientes-tasks">
                            <div class="kanban-task" style="opacity: 0.7; text-align: center;">
                                <div class="kanban-task-title">‚è≥ Cargando...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Columna En Proceso -->
                    <div class="kanban-column">
                        <div class="kanban-header">
                            <span class="kanban-icon">‚ö°</span>
                            <h4 class="kanban-title">Tareas en proceso (<span id="en-progreso-count">0</span>)</h4>
                        </div>
                        <div class="kanban-tasks" id="en-progreso-tasks">
                            <div class="kanban-task" style="opacity: 0.7; text-align: center;">
                                <div class="kanban-task-title">‚è≥ Cargando...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Columna Completadas -->
                    <div class="kanban-column">
                        <div class="kanban-header">
                            <span class="kanban-icon">‚úÖ</span>
                            <h4 class="kanban-title">Tareas completadas (<span id="terminadas-count">0</span>)</h4>
                        </div>
                        <div class="kanban-tasks" id="terminadas-tasks">
                            <div class="kanban-task" style="opacity: 0.7; text-align: center;">
                                <div class="kanban-task-title">‚è≥ Cargando...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n crear -->
                <div class="add-wrap">
                    <a href="crear-tarea.html" class="create-task-btn">
                        ‚ûï CREAR TAREA
                    </a>
                </div>
            </div>
        </main>

        <!-- FOOTER -->
        <footer class="footer">
            <a href="home.html" class="footer-link">
                <img src="/home.png" alt="inicio" class="icon" />
                <span class="footer-text">Inicio</span>
            </a>
        </footer>
    </div>

    <script>
        // Variables globales
        let tareas = {
            pendiente: [],
            en_progreso: [],
            terminada: []
        };
        let loading = true;

        // Detectar ambiente de desarrollo
        const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

        // Referencias DOM
        const elements = {
            username: document.getElementById('username'),
            successMessage: document.getElementById('success-message'),
            errorMessage: document.getElementById('error-message'),
            errorText: document.getElementById('error-text'),
            retryBtn: document.getElementById('retry-btn'),
            newLoginBtn: document.getElementById('new-login-btn'),
            debugInfo: document.getElementById('debug-info'),
            debugToken: document.getElementById('debug-token'),
            debugTasks: document.getElementById('debug-tasks'),
            taskSubtitle: document.getElementById('task-subtitle'),
            progressBar: document.getElementById('progress-bar'),
            progressPercentage: document.getElementById('progress-percentage'),
            progressTasks: document.getElementById('progress-tasks'),
            pendientesCount: document.getElementById('pendientes-count'),
            enProgresoCount: document.getElementById('en-progreso-count'),
            terminadasCount: document.getElementById('terminadas-count'),
            pendientesTasks: document.getElementById('pendientes-tasks'),
            enProgresoTasks: document.getElementById('en-progreso-tasks'),
            terminadasTasks: document.getElementById('terminadas-tasks')
        };

        // Funci√≥n para mostrar mensajes
        function showMessage(type, message, duration = 0) {
            const messageEl = elements[type + 'Message'];
            if (messageEl) {
                if (type === 'error') {
                    elements.errorText.textContent = message;
                } else {
                    messageEl.textContent = message;
                }
                messageEl.classList.remove('hidden');
                
                if (duration > 0) {
                    setTimeout(() => messageEl.classList.add('hidden'), duration);
                }
            }
        }

        function hideMessage(type) {
            const messageEl = elements[type + 'Message'];
            if (messageEl) {
                messageEl.classList.add('hidden');
            }
        }

        // Funci√≥n para actualizar debug info
        function updateDebugInfo() {
            if (isDevelopment) {
                elements.debugInfo.classList.remove('hidden');
                const token = localStorage.getItem('token');
                const totalTareas = tareas.pendiente.length + tareas.en_progreso.length + tareas.terminada.length;
                
                elements.debugToken.textContent = `Token: ${token ? '‚úÖ Presente' : '‚ùå Ausente'}`;
                elements.debugTasks.textContent = `Total tareas: ${totalTareas}`;
            }
        }

        // Funci√≥n para obtener clase de prioridad
        function getPriorityClass(prioridad) {
            switch(prioridad?.toLowerCase()) {
                case 'alta': return 'priority-alta';
                case 'media': return 'priority-media';
                case 'baja': return 'priority-baja';
                default: return 'priority-media';
            }
        }

        // Funci√≥n para escapar HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Funci√≥n para redirigir a editar tarea
        function editarTarea(tarea) {
            console.log('Editando tarea:', tarea);
            // Guardar datos en localStorage para acceso seguro
            localStorage.setItem('tareaParaEditar', JSON.stringify(tarea));
            
            // Redirigir a p√°gina de edici√≥n
            window.location.href = 'editar-tarea.html';
        }

        // Funci√≥n para redirigir a eliminar tarea
        function eliminarTarea(tarea) {
            console.log('Eliminando tarea:', tarea);
            // Guardar datos en localStorage para acceso seguro
            localStorage.setItem('tareaParaEliminar', JSON.stringify(tarea));
            
            // Redirigir a p√°gina de eliminaci√≥n
            window.location.href = 'eliminar-tarea.html';
        }

        // Funci√≥n para renderizar tareas con botones de acci√≥n
        function renderTareas(listaTareas, containerElement) {
            if (loading) {
                containerElement.innerHTML = `
                    <div class="kanban-task" style="opacity: 0.7; text-align: center;">
                        <div class="kanban-task-title">‚è≥ Cargando...</div>
                    </div>
                `;
                return;
            }

            if (listaTareas.length === 0) {
                containerElement.innerHTML = `
                    <div class="kanban-task" style="opacity: 0.5; font-style: italic;">
                        <div class="kanban-task-title">No hay tareas</div>
                    </div>
                `;
                return;
            }

            containerElement.innerHTML = listaTareas.map((tarea, index) => {
                const tareaId = tarea.id || tarea._id || index;
                return `
                    <div class="kanban-task" data-tarea-id="${tareaId}">
                        <div class="kanban-task-title">${escapeHtml(tarea.titulo || 'Sin t√≠tulo')}</div>
                        <span class="kanban-task-priority ${getPriorityClass(tarea.prioridad)}">
                            ${escapeHtml((tarea.prioridad || 'media').toUpperCase())}
                        </span>
                        <div class="task-actions">
                            <button class="task-action-btn edit" data-action="edit" data-tarea='${JSON.stringify(tarea)}'>
                                <img src="/edit.png" alt="editar" />
                            </button>
                            <button class="task-action-btn delete" data-action="delete" data-tarea='${JSON.stringify(tarea)}'>
                                <img src="/delete.png" alt="eliminar" />
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // Agregar event listeners a los botones reci√©n creados
            const editButtons = containerElement.querySelectorAll('[data-action="edit"]');
            const deleteButtons = containerElement.querySelectorAll('[data-action="delete"]');

            editButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const tarea = JSON.parse(this.getAttribute('data-tarea'));
                    editarTarea(tarea);
                });
            });

            deleteButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const tarea = JSON.parse(this.getAttribute('data-tarea'));
                    eliminarTarea(tarea);
                });
            });
        }

        // Funci√≥n para actualizar UI
        function updateUI() {
            const totalTareas = tareas.pendiente.length + tareas.en_progreso.length + tareas.terminada.length;
            const tareasCompletadas = tareas.terminada.length;
            const porcentajeProgreso = totalTareas > 0 ? Math.round((tareasCompletadas / totalTareas) * 100) : 0;

            // Actualizar contadores
            elements.pendientesCount.textContent = tareas.pendiente.length;
            elements.enProgresoCount.textContent = tareas.en_progreso.length;
            elements.terminadasCount.textContent = tareas.terminada.length;

            // Actualizar progreso
            elements.progressBar.style.width = `${porcentajeProgreso}%`;
            elements.progressPercentage.textContent = `${porcentajeProgreso}% completado`;
            elements.progressTasks.textContent = `${tareasCompletadas} de ${totalTareas} tareas ‚úÖ`;

            // Actualizar subt√≠tulo
            if (loading) {
                elements.taskSubtitle.textContent = "Cargando tus tareas...";
            } else if (!elements.errorMessage.classList.contains('hidden')) {
                elements.taskSubtitle.textContent = "Error cargando tareas";
            } else {
                elements.taskSubtitle.textContent = "Progreso general de tus tareas";
            }

            // Renderizar tareas en cada columna
            renderTareas(tareas.pendiente, elements.pendientesTasks);
            renderTareas(tareas.en_progreso, elements.enProgresoTasks);
            renderTareas(tareas.terminada, elements.terminadasTasks);

            // Actualizar debug info
            updateDebugInfo();
        }

        // Funci√≥n para forzar nuevo login
        function forzarNuevoLogin() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            localStorage.removeItem('userId');
            localStorage.removeItem('userName');
            window.location.href = 'login.html';
        }

        // Funci√≥n para cargar tareas
        async function cargarTareas() {
            const token = localStorage.getItem('token');
            
            console.log("=== CARGA DE TAREAS ===");
            console.log("Token presente:", token ? "‚úÖ S√ç" : "‚ùå NO");
            
            if (!token) {
                showMessage('error', "No hay sesi√≥n activa. Redirigiendo al login...");
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }

            try {
                loading = true;
                hideMessage('error');
                updateUI();

                console.log("Cargando tareas...");
                
                const response = await fetch("https://checknote-27fe.onrender.com/api/v1/tasks", {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json",
                    },
                });

                console.log("Response status:", response.status);

                if (!response.ok) {
                    if (response.status === 401) {
                        console.log("‚ùå 401 - Token inv√°lido o expirado");
                        
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        localStorage.removeItem('userId');
                        localStorage.removeItem('userName');
                        
                        showMessage('error', "Tu sesi√≥n ha expirado. Redirigiendo al login...");
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 2000);
                        return;
                    }
                    
                    const errorText = await response.text();
                    console.log("Error response:", errorText);
                    throw new Error(`Error ${response.status}: ${errorText || response.statusText}`);
                }

                // Procesar respuesta exitosa
                const responseText = await response.text();
                console.log("‚úÖ Respuesta exitosa:", responseText);

                let tareasData = [];
                try {
                    const responseData = responseText ? JSON.parse(responseText) : {};
                    tareasData = responseData.tasks || responseData.data || responseData;
                    if (!Array.isArray(tareasData)) {
                        tareasData = [];
                    }
                } catch (parseError) {
                    console.error("Error parseando JSON:", parseError);
                    tareasData = [];
                }
                
                // Organizar tareas por estado
                tareas = {
                    pendiente: tareasData.filter(tarea => tarea.estado === 'pendiente'),
                    en_progreso: tareasData.filter(tarea => tarea.estado === 'en_progreso'),
                    terminada: tareasData.filter(tarea => tarea.estado === 'terminada')
                };

                console.log("Tareas organizadas:", {
                    pendiente: tareas.pendiente.length,
                    en_progreso: tareas.en_progreso.length,
                    terminada: tareas.terminada.length
                });

            } catch (err) {
                console.error("Error cargando tareas:", err);
                showMessage('error', "Error al cargar las tareas: " + err.message);
            } finally {
                loading = false;
                updateUI();
            }
        }

        // Event listeners
        elements.retryBtn.addEventListener('click', cargarTareas);
        elements.newLoginBtn.addEventListener('click', forzarNuevoLogin);

        // Inicializaci√≥n al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, inicializando...');
            
            // Verificar si hay mensaje de √©xito del login, edici√≥n o eliminaci√≥n
            const loginSuccess = sessionStorage.getItem('loginExitoso');
            const editSuccess = sessionStorage.getItem('tareaEditadaExito');
            const deleteSuccess = sessionStorage.getItem('tareaEliminadaExito');
            
            if (loginSuccess) {
                showMessage('success', loginSuccess, 5000);
                sessionStorage.removeItem('loginExitoso');
            } else if (editSuccess) {
                showMessage('success', editSuccess, 5000);
                sessionStorage.removeItem('tareaEditadaExito');
            } else if (deleteSuccess) {
                showMessage('success', deleteSuccess, 5000);
                sessionStorage.removeItem('tareaEliminadaExito');
            }

            // Cargar datos del usuario
            const storedUser = localStorage.getItem('user');
            if (storedUser) {
                try {
                    const user = JSON.parse(storedUser);
                    elements.username.textContent = user.nombres || 'Usuario';
                } catch (e) {
                    elements.username.textContent = 'Usuario';
                }
            }

            // Cargar tareas con delay para evitar conflictos
            setTimeout(() => {
                cargarTareas();
            }, 100);

            // Configurar debug info si es desarrollo
            updateDebugInfo();
        });

        // Hacer las funciones globales para usar en onclick (backup)
        window.editarTarea = editarTarea;
        window.eliminarTarea = eliminarTarea;
    </script>
</body>
</html>