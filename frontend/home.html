
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CheckNote</title>
    <link rel="stylesheet" href="./GlobalCSS2.css">
    <style>
        /* Estilos adicionales espec√≠ficos solo para error messages */
        .error-message {
            padding: 16px;
            border-radius: 8px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            font-size: 14px;
            text-align: center;
            font-weight: 500;
            margin-bottom: 20px;
        }

        .error-message .error-title {
            font-weight: bold;
            margin-bottom: 8px;
        }

        .error-buttons {
            margin-top: 12px;
        }

        .error-btn {
            margin: 0 4px;
            padding: 8px 16px;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .error-btn.retry {
            background-color: rgba(255,255,255,0.2);
        }

        .error-btn.login {
            background-color: rgba(255,255,255,0.1);
        }

        /* DEBUG INFO */
        .debug-info {
            background: #2d3748;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 12px;
            color: #a0aec0;
            font-family: monospace;
        }

        .hidden {
            display: none;
        }

        /* Username styling */
        .username {
            color: var(--text-primary);
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="page-root">
        <!-- TOPBAR -->
        <header class="topbar">
            <div class="topbar-left">
                <img src="/usuario.png" alt="usuario" class="icon user-icon" />
                <span class="username" id="username">Usuario</span>
            </div>

            <div class="topbar-center">
                <div class="search-wrap">
                    <img src="/search.png" alt="buscar" class="search-icon" />
                    <input class="search-input" placeholder="Buscar tareas..." />
                </div>
            </div>

            <div class="topbar-right">
                <a href="perfil.html">
                    <img src="/settings.png" alt="configuraci√≥n" class="icon" />
                </a>
            </div>
        </header>

        <!-- MAIN -->
        <main class="main">
            <div class="center-column">
                <!-- Mensaje de √©xito -->
                <div id="success-message" class="success-message hidden"></div>

                <!-- Mensaje de error -->
                <div id="error-message" class="error-message hidden">
                    <div class="error-title">‚ö†Ô∏è Error de Conexi√≥n</div>
                    <div id="error-text"></div>
                    <div class="error-buttons">
                        <button id="retry-btn" class="error-btn retry">üîÑ Reintentar</button>
                        <button id="new-login-btn" class="error-btn login">üö™ Nuevo Login</button>
                    </div>
                </div>

                <!-- Debug info -->
                <div id="debug-info" class="debug-info hidden">
                    <strong>DEBUG INFO:</strong><br />
                    <span id="debug-token">Token: </span><br />
                    <span id="debug-tasks">Total tareas: </span>
                </div>

                <!-- Tarjeta de progreso -->
                <section class="task-card">
                    <h3 class="task-title">Panel de Tareas</h3>
                    <p class="task-sub" id="task-subtitle">Cargando tus tareas...</p>

                    <div class="progress-wrap">
                        <div class="progress-bar">
                            <div class="progress" id="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="progress-info">
                        <span id="progress-percentage">0% completado</span>
                        <span id="progress-tasks">0 de 0 tareas ‚úÖ</span>
                    </div>
                </section>

                <!-- Filtros -->
                <div class="filters">
                    <a href="tareas.html" class="filter">üìã Todas</a>
                    <button class="filter">üìÖ Calendario</button>
                    <button class="filter">‚≠ê Prioridad</button>
                </div>

                <!-- Layout Kanban -->
                <div class="kanban-container">
                    <!-- Columna Pendientes -->
                    <div class="kanban-column">
                        <div class="kanban-header">
                            <span class="kanban-icon">‚è∞</span>
                            <h4 class="kanban-title">Pendientes (<span id="pendientes-count">0</span>)</h4>
                        </div>
                        <div class="kanban-tasks" id="pendientes-tasks">
                            <div class="kanban-task" style="opacity: 0.7; text-align: center;">
                                <div class="kanban-task-title">‚è≥ Cargando...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Columna En Proceso -->
                    <div class="kanban-column">
                        <div class="kanban-header">
                            <span class="kanban-icon">‚ö°</span>
                            <h4 class="kanban-title">En Proceso (<span id="en-progreso-count">0</span>)</h4>
                        </div>
                        <div class="kanban-tasks" id="en-progreso-tasks">
                            <div class="kanban-task" style="opacity: 0.7; text-align: center;">
                                <div class="kanban-task-title">‚è≥ Cargando...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Columna Completadas -->
                    <div class="kanban-column">
                        <div class="kanban-header">
                            <span class="kanban-icon">‚úÖ</span>
                            <h4 class="kanban-title">Completadas (<span id="terminadas-count">0</span>)</h4>
                        </div>
                        <div class="kanban-tasks" id="terminadas-tasks">
                            <div class="kanban-task" style="opacity: 0.7; text-align: center;">
                                <div class="kanban-task-title">‚è≥ Cargando...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n flotante -->
                <div class="add-wrap">
                    <div class="floating-menu">
                        <div class="floating-options" id="floating-options">
                            <a href="crear-tarea.html" class="floating-option create">üìù</a>
                            <a href="editar-tarea.html" class="floating-option edit">‚úèÔ∏è</a>
                            <a href="eliminar-tarea.html" class="floating-option delete">üóëÔ∏è</a>
                        </div>
                        <button class="add-btn" id="add-btn">+</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- FOOTER -->
        <footer class="footer">
            <a href="home.html" class="footer-link">
                <img src="/home.png" alt="inicio" class="icon" />
                <span class="footer-text">Inicio</span>
            </a>
        </footer>
    </div>

    <script>
        // Variables globales
        let tareas = {
            pendiente: [],
            en_progreso: [],
            terminada: []
        };
        let loading = true;
        let menuOpen = false;

        // Detectar ambiente de desarrollo
        const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

        // Referencias DOM
        const elements = {
            username: document.getElementById('username'),
            successMessage: document.getElementById('success-message'),
            errorMessage: document.getElementById('error-message'),
            errorText: document.getElementById('error-text'),
            retryBtn: document.getElementById('retry-btn'),
            newLoginBtn: document.getElementById('new-login-btn'),
            debugInfo: document.getElementById('debug-info'),
            debugToken: document.getElementById('debug-token'),
            debugTasks: document.getElementById('debug-tasks'),
            taskSubtitle: document.getElementById('task-subtitle'),
            progressBar: document.getElementById('progress-bar'),
            progressPercentage: document.getElementById('progress-percentage'),
            progressTasks: document.getElementById('progress-tasks'),
            pendientesCount: document.getElementById('pendientes-count'),
            enProgresoCount: document.getElementById('en-progreso-count'),
            terminadasCount: document.getElementById('terminadas-count'),
            pendientesTasks: document.getElementById('pendientes-tasks'),
            enProgresoTasks: document.getElementById('en-progreso-tasks'),
            terminadasTasks: document.getElementById('terminadas-tasks'),
            floatingOptions: document.getElementById('floating-options'),
            addBtn: document.getElementById('add-btn')
        };

        // Funci√≥n para mostrar mensajes
        function showMessage(type, message, duration = 0) {
            const messageEl = elements[type + 'Message'];
            if (messageEl) {
                if (type === 'error') {
                    elements.errorText.textContent = message;
                } else {
                    messageEl.textContent = message;
                }
                messageEl.classList.remove('hidden');
                
                if (duration > 0) {
                    setTimeout(() => messageEl.classList.add('hidden'), duration);
                }
            }
        }

        function hideMessage(type) {
            const messageEl = elements[type + 'Message'];
            if (messageEl) {
                messageEl.classList.add('hidden');
            }
        }

        // Funci√≥n para actualizar debug info
        function updateDebugInfo() {
            if (isDevelopment) {
                elements.debugInfo.classList.remove('hidden');
                const token = localStorage.getItem('token');
                const totalTareas = tareas.pendiente.length + tareas.en_progreso.length + tareas.terminada.length;
                
                elements.debugToken.textContent = `Token: ${token ? '‚úÖ Presente' : '‚ùå Ausente'}`;
                elements.debugTasks.textContent = `Total tareas: ${totalTareas}`;
            }
        }

        // Funci√≥n para obtener clase de prioridad
        function getPriorityClass(prioridad) {
            switch(prioridad?.toLowerCase()) {
                case 'alta': return 'priority-alta';
                case 'media': return 'priority-media';
                case 'baja': return 'priority-baja';
                default: return 'priority-media';
            }
        }

        // Funci√≥n para renderizar tareas
        function renderTareas(listaTareas, containerElement) {
            if (loading) {
                containerElement.innerHTML = `
                    <div class="kanban-task" style="opacity: 0.7; text-align: center;">
                        <div class="kanban-task-title">‚è≥ Cargando...</div>
                    </div>
                `;
                return;
            }

            if (listaTareas.length === 0) {
                containerElement.innerHTML = `
                    <div class="kanban-task" style="opacity: 0.5; font-style: italic;">
                        <div class="kanban-task-title">No hay tareas</div>
                    </div>
                `;
                return;
            }

            containerElement.innerHTML = listaTareas.map(tarea => `
                <div class="kanban-task">
                    <div class="kanban-task-title">${tarea.titulo || 'Sin t√≠tulo'}</div>
                    <span class="kanban-task-priority ${getPriorityClass(tarea.prioridad)}">
                        ${(tarea.prioridad || 'media').toUpperCase()}
                    </span>
                </div>
            `).join('');
        }

        // Funci√≥n para actualizar UI
        function updateUI() {
            const totalTareas = tareas.pendiente.length + tareas.en_progreso.length + tareas.terminada.length;
            const tareasCompletadas = tareas.terminada.length;
            const porcentajeProgreso = totalTareas > 0 ? Math.round((tareasCompletadas / totalTareas) * 100) : 0;

            // Actualizar contadores
            elements.pendientesCount.textContent = tareas.pendiente.length;
            elements.enProgresoCount.textContent = tareas.en_progreso.length;
            elements.terminadasCount.textContent = tareas.terminada.length;

            // Actualizar progreso
            elements.progressBar.style.width = `${porcentajeProgreso}%`;
            elements.progressPercentage.textContent = `${porcentajeProgreso}% completado`;
            elements.progressTasks.textContent = `${tareasCompletadas} de ${totalTareas} tareas ‚úÖ`;

            // Actualizar subt√≠tulo
            if (loading) {
                elements.taskSubtitle.textContent = "Cargando tus tareas...";
            } else if (elements.errorMessage.classList.contains('hidden') === false) {
                elements.taskSubtitle.textContent = "Error cargando tareas";
            } else {
                elements.taskSubtitle.textContent = "Progreso general de tus tareas";
            }

            // Renderizar tareas en cada columna
            renderTareas(tareas.pendiente, elements.pendientesTasks);
            renderTareas(tareas.en_progreso, elements.enProgresoTasks);
            renderTareas(tareas.terminada, elements.terminadasTasks);

            // Actualizar debug info
            updateDebugInfo();
        }

        // Funci√≥n para forzar nuevo login
        function forzarNuevoLogin() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            localStorage.removeItem('userId');
            localStorage.removeItem('userName');
            window.location.href = 'login.html';
        }

        // Funci√≥n SUPER SIMPLE para cargar tareas - SIN VERIFY
        async function cargarTareas() {
            const token = localStorage.getItem('token');
            
            console.log("=== CARGA SIMPLE DE TAREAS ===");
            console.log("Token presente:", token ? "‚úÖ S√ç" : "‚ùå NO");
            
            if (!token) {
                showMessage('error', "No hay sesi√≥n activa. Redirigiendo al login...");
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }

            try {
                loading = true;
                hideMessage('error');
                updateUI();

                console.log("Cargando tareas directamente (SIN verify)...");
                console.log("Token completo que se est√° enviando:", token);
                console.log("Longitud del token:", token.length);
                console.log("¬øEmpieza con 'Bearer'?", token.startsWith('Bearer'));
                
                const response = await fetch("https://checknote-27fe.onrender.com/api/v1/tasks", {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json",
                    },
                });

                console.log("Tasks response status:", response.status);
                console.log("Tasks response headers:", Object.fromEntries(response.headers.entries()));

                if (!response.ok) {
                    const errorText = await response.text();
                    console.log("‚ùå Error response body completo:", errorText);
                    
                    if (response.status === 401) {
                        console.log("‚ùå 401 en /tasks - Token inv√°lido o expirado");
                        
                        // ANTES de limpiar, vamos a intentar hacer verify nuevamente para comparar
                        console.log("üîç Haciendo verify nuevamente para comparar...");
                        try {
                            const testVerify = await fetch("https://checknote-27fe.onrender.com/api/v1/auth/verify", {
                                method: "POST",
                                headers: {
                                    "Authorization": `Bearer ${token}`,
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify({}) // ‚Üê AGREGAR BODY VAC√çO PARA EVITAR ERROR JSON
                            });
                            console.log("üîç Test verify status:", testVerify.status);
                            if (testVerify.ok) {
                                const testVerifyData = await testVerify.json();
                                console.log("üîç Test verify data:", testVerifyData);
                            } else {
                                const testVerifyError = await testVerify.text();
                                console.log("üîç Test verify error:", testVerifyError);
                            }
                        } catch (verifyErr) {
                            console.log("üîç Error en test verify:", verifyErr);
                        }
                        
                        // Limpiar sesi√≥n solo despu√©s de la investigaci√≥n
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        localStorage.removeItem('userId');
                        localStorage.removeItem('userName');
                        
                        showMessage('error', "Tu sesi√≥n ha expirado. Redirigiendo al login...");
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 2000);
                        return;
                    }
                    
                    console.log("Error response body:", errorText);
                    throw new Error(`Error ${response.status}: ${errorText || response.statusText}`);
                }

                // Procesar respuesta exitosa
                const responseText = await response.text();
                console.log("‚úÖ Respuesta exitosa:", responseText);

                let tareasData = [];
                try {
                    const responseData = responseText ? JSON.parse(responseText) : {};
                    // Manejar diferentes estructuras de respuesta
                    tareasData = responseData.tasks || responseData.data || responseData;
                    if (!Array.isArray(tareasData)) {
                        tareasData = [];
                    }
                } catch (parseError) {
                    console.error("Error parseando JSON:", parseError);
                    tareasData = [];
                }
                
                // Organizar tareas por estado
                tareas = {
                    pendiente: tareasData.filter(tarea => tarea.estado === 'pendiente'),
                    en_progreso: tareasData.filter(tarea => tarea.estado === 'en_progreso'),
                    terminada: tareasData.filter(tarea => tarea.estado === 'terminada')
                };

                console.log("Tareas organizadas:", {
                    pendiente: tareas.pendiente.length,
                    en_progreso: tareas.en_progreso.length,
                    terminada: tareas.terminada.length
                });

            } catch (err) {
                console.error("Error cargando tareas:", err);
                showMessage('error', "Error al cargar las tareas: " + err.message);
            } finally {
                loading = false;
                updateUI();
            }
        }

        // Toggle del men√∫ flotante
        function toggleMenu() {
            menuOpen = !menuOpen;
            elements.floatingOptions.classList.toggle('active', menuOpen);
            elements.addBtn.classList.toggle('active', menuOpen);
        }

        // Event listeners
        elements.retryBtn.addEventListener('click', cargarTareas);
        elements.newLoginBtn.addEventListener('click', forzarNuevoLogin);
        elements.addBtn.addEventListener('click', toggleMenu);

        // Inicializaci√≥n al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si hay mensaje de √©xito del login
            const loginSuccess = sessionStorage.getItem('loginExitoso');
            if (loginSuccess) {
                showMessage('success', loginSuccess, 5000);
                sessionStorage.removeItem('loginExitoso');
            }

            // Cargar datos del usuario
            const storedUser = localStorage.getItem('user');
            if (storedUser) {
                try {
                    const user = JSON.parse(storedUser);
                    elements.username.textContent = user.nombres || 'Usuario';
                } catch (e) {
                    elements.username.textContent = 'Usuario';
                }
            }

            // Cargar tareas
            cargarTareas();

            // Configurar debug info si es desarrollo
            updateDebugInfo();
        });
    </script>
</body>
</html>