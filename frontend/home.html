<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CheckNote</title>
    <link rel="stylesheet" href="./GlobalCSS2.css">
    <style>
        /* Estilos adicionales espec√≠ficos */
        .error-message {
            padding: 16px;
            border-radius: 8px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            font-size: 14px;
            text-align: center;
            font-weight: 500;
            margin-bottom: 20px;
        }

        .error-message .error-title {
            font-weight: bold;
            margin-bottom: 8px;
        }

        .error-buttons {
            margin-top: 12px;
        }

        .error-btn {
            margin: 0 4px;
            padding: 8px 16px;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            border: 1px solid rgba(255,255,255,0.3);
            background: none;
        }

        .error-btn.retry {
            background-color: rgba(255,255,255,0.2);
        }

        .error-btn.login {
            background-color: rgba(255,255,255,0.1);
        }

        .debug-info {
            background: #2d3748;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 12px;
            color: #a0aec0;
            font-family: monospace;
        }

        .hidden {
            display: none;
        }

        .username {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Logo espec√≠fico */
        .logo-icon {
            width: 32px;
            height: 32px;
            object-fit: contain;
        }

        /* Kanban mejorado - SIEMPRE 3 columnas horizontales */
        .kanban-container {
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: var(--spacing-lg);
            justify-content: center;
            margin-bottom: var(--spacing-xl);
        }

        .kanban-column {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-card);
        }

        .kanban-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--border-color);
        }

        .kanban-icon {
            font-size: 20px;
        }

        .kanban-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-primary);
            margin: 0;
        }

        .kanban-tasks {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            min-height: 200px;
        }

        .kanban-task {
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            transition: all var(--transition);
            cursor: pointer;
        }

        .kanban-task:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-card);
        }

        .kanban-task-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
            font-size: 14px;
        }

        .kanban-task-priority {
            display: inline-block;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: var(--spacing-sm);
        }

        .priority-alta {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .priority-media {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .priority-baja {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        /* Acciones de tarea */
        .task-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            justify-content: flex-end;
        }

        .task-action-btn {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition);
            opacity: 0.7;
        }

        .task-action-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .task-action-btn.edit {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .task-action-btn.delete {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .task-action-btn img {
            width: 14px;
            height: 14px;
            filter: brightness(0) invert(1);
        }

        /* Bot√≥n crear simple */
        .create-btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
            color: white; 
            border: none; 
            width: 56px; 
            height: 56px; 
            border-radius: 50%;
            font-size: 24px; 
            cursor: pointer; 
            box-shadow: var(--shadow-add-btn);
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .create-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(16,185,129,0.4);
        }

        /* Modal de confirmaci√≥n */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 24px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-card);
            color: var(--text-primary);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            justify-content: center;
        }

        .modal-btn {
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
        }

        .modal-btn.confirm {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .modal-btn.cancel {
            background: rgba(255,255,255,0.1);
            color: var(--text-secondary);
        }

        /* Responsive kanban - MANTENER 3 COLUMNAS SIEMPRE */
        @media (max-width: 900px) {
            .kanban-container {
                grid-template-columns: 1fr 1fr 1fr;
                gap: var(--spacing-md);
            }
            
            .kanban-column {
                padding: var(--spacing-md);
            }
            
            .kanban-task-title {
                font-size: 12px;
            }
        }

        @media (max-width: 600px) {
            .kanban-container {
                grid-template-columns: 1fr 1fr 1fr;
                gap: var(--spacing-sm);
            }
            
            .kanban-column {
                padding: var(--spacing-sm);
            }
            
            .kanban-header {
                margin-bottom: var(--spacing-md);
            }
            
            .kanban-title {
                font-size: 12px;
            }
            
            .kanban-task {
                padding: var(--spacing-sm);
            }
            
            .task-action-btn {
                width: 20px;
                height: 20px;
            }
            
            .task-action-btn img {
                width: 12px;
                height: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="page-root">
        <!-- TOPBAR -->
        <header class="topbar">
            <div class="topbar-left">
                <a href="sobrenosotros.html" style="display: flex; align-items: center; text-decoration: none;">
                    <img src="/logo.png" alt="logo" class="icon logo-icon" />
                </a>
            </div>

            <div class="topbar-center">
                <div class="search-wrap">
                    <img src="/search.png" alt="buscar" class="search-icon" />
                    <input class="search-input" placeholder="Buscar tareas..." />
                </div>
            </div>

            <div class="topbar-right">
                <img src="/usuario.png" alt="usuario" class="icon user-icon" />
                <span class="username" id="username">Usuario</span>
            </div>
        </header>

        <!-- MAIN -->
        <main class="main">
            <div class="center-column">
                <!-- Mensaje de √©xito -->
                <div id="success-message" class="success-message hidden"></div>

                <!-- Mensaje de error -->
                <div id="error-message" class="error-message hidden">
                    <div class="error-title">‚ö†Ô∏è Error de Conexi√≥n</div>
                    <div id="error-text"></div>
                    <div class="error-buttons">
                        <button id="retry-btn" class="error-btn retry">üîÑ Reintentar</button>
                        <button id="new-login-btn" class="error-btn login">üö™ Nuevo Login</button>
                    </div>
                </div>

                <!-- Debug info -->
                <div id="debug-info" class="debug-info hidden">
                    <strong>DEBUG INFO:</strong><br />
                    <span id="debug-token">Token: </span><br />
                    <span id="debug-tasks">Total tareas: </span>
                </div>

                <!-- Tarjeta de progreso -->
                <section class="task-card">
                    <h3 class="task-title">Panel de Tareas</h3>
                    <p class="task-sub" id="task-subtitle">Cargando tus tareas...</p>

                    <div class="progress-wrap">
                        <div class="progress-bar">
                            <div class="progress" id="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="progress-info">
                        <span id="progress-percentage">0% completado</span>
                        <span id="progress-tasks">0 de 0 tareas ‚úÖ</span>
                    </div>
                </section>

                <!-- Layout Kanban -->
                <div class="kanban-container">
                    <!-- Columna Pendientes -->
                    <div class="kanban-column">
                        <div class="kanban-header">
                            <span class="kanban-icon">‚è∞</span>
                            <h4 class="kanban-title">Tareas pendientes (<span id="pendientes-count">0</span>)</h4>
                        </div>
                        <div class="kanban-tasks" id="pendientes-tasks">
                            <div class="kanban-task" style="opacity: 0.7; text-align: center;">
                                <div class="kanban-task-title">‚è≥ Cargando...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Columna En Proceso -->
                    <div class="kanban-column">
                        <div class="kanban-header">
                            <span class="kanban-icon">‚ö°</span>
                            <h4 class="kanban-title">Tareas en proceso (<span id="en-progreso-count">0</span>)</h4>
                        </div>
                        <div class="kanban-tasks" id="en-progreso-tasks">
                            <div class="kanban-task" style="opacity: 0.7; text-align: center;">
                                <div class="kanban-task-title">‚è≥ Cargando...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Columna Completadas -->
                    <div class="kanban-column">
                        <div class="kanban-header">
                            <span class="kanban-icon">‚úÖ</span>
                            <h4 class="kanban-title">Tareas completadas (<span id="terminadas-count">0</span>)</h4>
                        </div>
                        <div class="kanban-tasks" id="terminadas-tasks">
                            <div class="kanban-task" style="opacity: 0.7; text-align: center;">
                                <div class="kanban-task-title">‚è≥ Cargando...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n crear -->
                <div class="add-wrap">
                    <a href="crear-tarea.html" class="create-btn">
                        +
                    </a>
                </div>
            </div>
        </main>

        <!-- FOOTER -->
        <footer class="footer">
            <a href="home.html" class="footer-link">
                <img src="/home.png" alt="inicio" class="icon" />
                <span class="footer-text">Inicio</span>
            </a>
        </footer>
    </div>

    <!-- Modal de confirmaci√≥n para eliminar -->
    <div id="delete-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>üóëÔ∏è Confirmar Eliminaci√≥n</h3>
            <p id="delete-message">¬øEst√°s seguro de que quieres eliminar esta tarea?</p>
            <div class="modal-buttons">
                <button id="confirm-delete" class="modal-btn confirm">Eliminar</button>
                <button id="cancel-delete" class="modal-btn cancel">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let tareas = {
            pendiente: [],
            en_progreso: [],
            terminada: []
        };
        let loading = true;
        let tareaSeleccionadaParaEliminar = null;

        // Detectar ambiente de desarrollo
        const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

        // Referencias DOM
        const elements = {
            username: document.getElementById('username'),
            successMessage: document.getElementById('success-message'),
            errorMessage: document.getElementById('error-message'),
            errorText: document.getElementById('error-text'),
            retryBtn: document.getElementById('retry-btn'),
            newLoginBtn: document.getElementById('new-login-btn'),
            debugInfo: document.getElementById('debug-info'),
            debugToken: document.getElementById('debug-token'),
            debugTasks: document.getElementById('debug-tasks'),
            taskSubtitle: document.getElementById('task-subtitle'),
            progressBar: document.getElementById('progress-bar'),
            progressPercentage: document.getElementById('progress-percentage'),
            progressTasks: document.getElementById('progress-tasks'),
            pendientesCount: document.getElementById('pendientes-count'),
            enProgresoCount: document.getElementById('en-progreso-count'),
            terminadasCount: document.getElementById('terminadas-count'),
            pendientesTasks: document.getElementById('pendientes-tasks'),
            enProgresoTasks: document.getElementById('en-progreso-tasks'),
            terminadasTasks: document.getElementById('terminadas-tasks'),
            
            // Modal de eliminaci√≥n
            deleteModal: document.getElementById('delete-modal'),
            deleteMessage: document.getElementById('delete-message'),
            confirmDelete: document.getElementById('confirm-delete'),
            cancelDelete: document.getElementById('cancel-delete')
        };

        // Funci√≥n para mostrar mensajes
        function showMessage(type, message, duration = 0) {
            const messageEl = elements[type + 'Message'];
            if (messageEl) {
                if (type === 'error') {
                    elements.errorText.textContent = message;
                } else {
                    messageEl.textContent = message;
                }
                messageEl.classList.remove('hidden');
                
                if (duration > 0) {
                    setTimeout(() => messageEl.classList.add('hidden'), duration);
                }
            }
        }

        function hideMessage(type) {
            const messageEl = elements[type + 'Message'];
            if (messageEl) {
                messageEl.classList.add('hidden');
            }
        }

        // Funci√≥n para actualizar debug info
        function updateDebugInfo() {
            if (isDevelopment) {
                elements.debugInfo.classList.remove('hidden');
                const token = localStorage.getItem('token');
                const totalTareas = tareas.pendiente.length + tareas.en_progreso.length + tareas.terminada.length;
                
                elements.debugToken.textContent = `Token: ${token ? '‚úÖ Presente' : '‚ùå Ausente'}`;
                elements.debugTasks.textContent = `Total tareas: ${totalTareas}`;
            }
        }

        // Funci√≥n para obtener clase de prioridad
        function getPriorityClass(prioridad) {
            switch(prioridad?.toLowerCase()) {
                case 'alta': return 'priority-alta';
                case 'media': return 'priority-media';
                case 'baja': return 'priority-baja';
                default: return 'priority-media';
            }
        }

        // Funci√≥n para escapar HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Funci√≥n para redirigir a editar tarea
        function editarTarea(tarea) {
            console.log('Editando tarea:', tarea);
            // Guardar datos en localStorage para acceso seguro
            localStorage.setItem('tareaParaEditar', JSON.stringify(tarea));
            
            // Redirigir a p√°gina de edici√≥n
            window.location.href = 'editar-tarea.html';
        }

        // Funci√≥n para mostrar modal de eliminaci√≥n
        function mostrarModalEliminar(tarea) {
            console.log('Mostrando modal eliminar para:', tarea);
            tareaSeleccionadaParaEliminar = tarea;
            elements.deleteMessage.textContent = `¬øEst√°s seguro de que quieres eliminar "${tarea.titulo}"?`;
            elements.deleteModal.classList.remove('hidden');
        }

        // Funci√≥n para ocultar modal de eliminaci√≥n
        function ocultarModalEliminar() {
            tareaSeleccionadaParaEliminar = null;
            elements.deleteModal.classList.add('hidden');
        }

        // Funci√≥n para eliminar tarea
        async function eliminarTarea() {
            if (!tareaSeleccionadaParaEliminar) return;

            const token = localStorage.getItem('token');
            if (!token) {
                showMessage('error', 'No hay sesi√≥n activa');
                return;
            }

            try {
                elements.confirmDelete.disabled = true;
                elements.confirmDelete.textContent = 'Eliminando...';

                const tareaId = tareaSeleccionadaParaEliminar.id || tareaSeleccionadaParaEliminar._id;
                const response = await fetch(`https://checknote-27fe.onrender.com/api/v1/tasks/delete/${tareaId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        localStorage.removeItem('userId');
                        localStorage.removeItem('userName');
                        
                        showMessage('error', 'Sesi√≥n expirada. Redirigiendo...');
                        setTimeout(() => window.location.href = 'login.html', 2000);
                        return;
                    }
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                console.log('Tarea eliminada exitosamente');
                showMessage('success', 'üóëÔ∏è Tarea eliminada exitosamente', 3000);
                
                // Recargar tareas
                await cargarTareas();
                
            } catch (err) {
                console.error('Error eliminando tarea:', err);
                showMessage('error', 'Error al eliminar la tarea: ' + err.message);
            } finally {
                elements.confirmDelete.disabled = false;
                elements.confirmDelete.textContent = 'Eliminar';
                ocultarModalEliminar();
            }
        }

        // Funci√≥n para renderizar tareas con botones de acci√≥n
        function renderTareas(listaTareas, containerElement) {
            if (loading) {
                containerElement.innerHTML = `
                    <div class="kanban-task" style="opacity: 0.7; text-align: center;">
                        <div class="kanban-task-title">‚è≥ Cargando...</div>
                    </div>
                `;
                return;
            }

            if (listaTareas.length === 0) {
                containerElement.innerHTML = `
                    <div class="kanban-task" style="opacity: 0.5; font-style: italic;">
                        <div class="kanban-task-title">No hay tareas</div>
                    </div>
                `;
                return;
            }

            containerElement.innerHTML = listaTareas.map((tarea, index) => {
                const tareaId = tarea.id || tarea._id || index;
                return `
                    <div class="kanban-task" data-tarea-id="${tareaId}">
                        <div class="kanban-task-title">${escapeHtml(tarea.titulo || 'Sin t√≠tulo')}</div>
                        <span class="kanban-task-priority ${getPriorityClass(tarea.prioridad)}">
                            ${escapeHtml((tarea.prioridad || 'media').toUpperCase())}
                        </span>
                        <div class="task-actions">
                            <button class="task-action-btn edit" data-action="edit" data-tarea='${JSON.stringify(tarea)}'>
                                <img src="/edit.png" alt="editar" />
                            </button>
                            <button class="task-action-btn delete" data-action="delete" data-tarea='${JSON.stringify(tarea)}'>
                                <img src="/delete.png" alt="eliminar" />
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // Agregar event listeners a los botones reci√©n creados
            const editButtons = containerElement.querySelectorAll('[data-action="edit"]');
            const deleteButtons = containerElement.querySelectorAll('[data-action="delete"]');

            editButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const tarea = JSON.parse(this.getAttribute('data-tarea'));
                    editarTarea(tarea);
                });
            });

            deleteButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const tarea = JSON.parse(this.getAttribute('data-tarea'));
                    mostrarModalEliminar(tarea);
                });
            });
        }

        // Funci√≥n para actualizar UI
        function updateUI() {
            const totalTareas = tareas.pendiente.length + tareas.en_progreso.length + tareas.terminada.length;
            const tareasCompletadas = tareas.terminada.length;
            const porcentajeProgreso = totalTareas > 0 ? Math.round((tareasCompletadas / totalTareas) * 100) : 0;

            // Actualizar contadores
            elements.pendientesCount.textContent = tareas.pendiente.length;
            elements.enProgresoCount.textContent = tareas.en_progreso.length;
            elements.terminadasCount.textContent = tareas.terminada.length;

            // Actualizar progreso
            elements.progressBar.style.width = `${porcentajeProgreso}%`;
            elements.progressPercentage.textContent = `${porcentajeProgreso}% completado`;
            elements.progressTasks.textContent = `${tareasCompletadas} de ${totalTareas} tareas ‚úÖ`;

            // Actualizar subt√≠tulo
            if (loading) {
                elements.taskSubtitle.textContent = "Cargando tus tareas...";
            } else if (!elements.errorMessage.classList.contains('hidden')) {
                elements.taskSubtitle.textContent = "Error cargando tareas";
            } else {
                elements.taskSubtitle.textContent = "Progreso general de tus tareas";
            }

            // Renderizar tareas en cada columna
            renderTareas(tareas.pendiente, elements.pendientesTasks);
            renderTareas(tareas.en_progreso, elements.enProgresoTasks);
            renderTareas(tareas.terminada, elements.terminadasTasks);

            // Actualizar debug info
            updateDebugInfo();
        }

        // Funci√≥n para forzar nuevo login
        function forzarNuevoLogin() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            localStorage.removeItem('userId');
            localStorage.removeItem('userName');
            window.location.href = 'login.html';
        }

        // Funci√≥n para cargar tareas
        async function cargarTareas() {
            const token = localStorage.getItem('token');
            
            console.log("=== CARGA DE TAREAS ===");
            console.log("Token presente:", token ? "‚úÖ S√ç" : "‚ùå NO");
            
            if (!token) {
                showMessage('error', "No hay sesi√≥n activa. Redirigiendo al login...");
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }

            try {
                loading = true;
                hideMessage('error');
                updateUI();

                console.log("Cargando tareas...");
                
                const response = await fetch("https://checknote-27fe.onrender.com/api/v1/tasks", {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json",
                    },
                });

                console.log("Response status:", response.status);

                if (!response.ok) {
                    if (response.status === 401) {
                        console.log("‚ùå 401 - Token inv√°lido o expirado");
                        
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        localStorage.removeItem('userId');
                        localStorage.removeItem('userName');
                        
                        showMessage('error', "Tu sesi√≥n ha expirado. Redirigiendo al login...");
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 2000);
                        return;
                    }
                    
                    const errorText = await response.text();
                    console.log("Error response:", errorText);
                    throw new Error(`Error ${response.status}: ${errorText || response.statusText}`);
                }

                // Procesar respuesta exitosa
                const responseText = await response.text();
                console.log("‚úÖ Respuesta exitosa:", responseText);

                let tareasData = [];
                try {
                    const responseData = responseText ? JSON.parse(responseText) : {};
                    tareasData = responseData.tasks || responseData.data || responseData;
                    if (!Array.isArray(tareasData)) {
                        tareasData = [];
                    }
                } catch (parseError) {
                    console.error("Error parseando JSON:", parseError);
                    tareasData = [];
                }
                
                // Organizar tareas por estado
                tareas = {
                    pendiente: tareasData.filter(tarea => tarea.estado === 'pendiente'),
                    en_progreso: tareasData.filter(tarea => tarea.estado === 'en_progreso'),
                    terminada: tareasData.filter(tarea => tarea.estado === 'terminada')
                };

                console.log("Tareas organizadas:", {
                    pendiente: tareas.pendiente.length,
                    en_progreso: tareas.en_progreso.length,
                    terminada: tareas.terminada.length
                });

            } catch (err) {
                console.error("Error cargando tareas:", err);
                showMessage('error', "Error al cargar las tareas: " + err.message);
            } finally {
                loading = false;
                updateUI();
            }
        }

        // Event listeners
        elements.retryBtn.addEventListener('click', cargarTareas);
        elements.newLoginBtn.addEventListener('click', forzarNuevoLogin);
        
        // Modales
        elements.cancelDelete.addEventListener('click', ocultarModalEliminar);
        elements.confirmDelete.addEventListener('click', eliminarTarea);

        // Cerrar modal al hacer click fuera
        elements.deleteModal.addEventListener('click', function(e) {
            if (e.target === elements.deleteModal) {
                ocultarModalEliminar();
            }
        });

        // Inicializaci√≥n al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, inicializando...');
            
            // Asegurar que el modal est√© oculto al inicio
            elements.deleteModal.classList.add('hidden');
            tareaSeleccionadaParaEliminar = null;
            
            // Verificar si hay mensaje de √©xito del login o edici√≥n
            const loginSuccess = sessionStorage.getItem('loginExitoso');
            const editSuccess = sessionStorage.getItem('tareaEditadaExito');
            
            if (loginSuccess) {
                showMessage('success', loginSuccess, 5000);
                sessionStorage.removeItem('loginExitoso');
            } else if (editSuccess) {
                showMessage('success', editSuccess, 5000);
                sessionStorage.removeItem('tareaEditadaExito');
            }

            // Cargar datos del usuario
            const storedUser = localStorage.getItem('user');
            if (storedUser) {
                try {
                    const user = JSON.parse(storedUser);
                    elements.username.textContent = user.nombres || 'Usuario';
                } catch (e) {
                    elements.username.textContent = 'Usuario';
                }
            }

            // Cargar tareas con delay para evitar conflictos
            setTimeout(() => {
                cargarTareas();
            }, 100);

            // Configurar debug info si es desarrollo
            updateDebugInfo();
        });

        // Hacer las funciones globales para usar en onclick (backup, aunque ya no las usamos)
        window.editarTarea = editarTarea;
        window.mostrarModalEliminar = mostrarModalEliminar;
    </script>
</body>
</html>