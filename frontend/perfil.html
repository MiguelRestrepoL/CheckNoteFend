<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil - CheckNote</title>
    <link rel="stylesheet" href="./GlobalCSS2.css">
    <style>
        /* Estilos específicos del perfil */
        .profile-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: var(--spacing-xl);
            margin-top: var(--spacing-xl);
        }

        .profile-sidebar {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-card);
            height: fit-content;
        }

        .brand-logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-xl);
            padding-bottom: var(--spacing-lg);
            border-bottom: 2px solid var(--border-color);
        }

        .brand-icon {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .brand-text {
            font-size: 20px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .nav-button {
            background: none;
            border: none;
            padding: var(--spacing-md);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            text-align: left;
        }

        .nav-button:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }

        .nav-button.active {
            background: var(--primary);
            color: white;
        }

        .nav-button.danger {
            color: #ef4444;
        }

        .nav-button.danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .profile-content {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-card);
        }

        .section-header {
            font-size: 24px;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }

        .section-description {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xl);
            line-height: 1.5;
        }

        .form-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .form-field {
            margin-bottom: var(--spacing-lg);
        }

        .form-field .form-label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 500;
            color: var(--text-primary);
        }

        .width-sm { max-width: 200px; }
        .width-md { max-width: 300px; }

        .danger-zone {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid rgba(239, 68, 68, 0.3);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            margin-top: var(--spacing-xl);
        }

        .danger-zone-title {
            color: #ef4444;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: var(--spacing-sm);
        }

        .danger-zone-description {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-lg);
        }

        .loading-container {
            text-align: center;
            padding: var(--spacing-3xl);
            color: var(--text-secondary);
        }

        .loading-icon {
            font-size: 48px;
            margin-top: var(--spacing-lg);
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .profile-container {
                grid-template-columns: 1fr;
                gap: var(--spacing-lg);
            }

            .form-grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="page-root">
        <!-- TOPBAR CORREGIDO -->
        <header class="topbar">
            <div class="topbar-left">
                <a href="home.html" style="display: flex; align-items: center; text-decoration: none;">
                    <img src="/back.png" alt="volver" class="icon" style="margin-right: 8px;" />
                    <span style="color: var(--text-primary);">Volver</span>
                </a>
            </div>

            <div class="topbar-center">
                <span style="color: var(--text-primary); font-weight: 500;">Mi Perfil</span>
            </div>

            <div class="topbar-right">
                <a href="home.html" style="display: flex; align-items: center; gap: 8px; text-decoration: none;">
                    <img src="/usuario.png" alt="usuario" class="icon user-icon" />
                    <span class="username" id="topbar-username">Usuario</span>
                </a>
            </div>
        </header>

        <!-- MAIN -->
        <main class="main">
            <div class="center-column" style="max-width: 1000px;">
                
                <!-- Loading Screen -->
                <div id="loading-container" class="loading-container">
                    <h3>Cargando tu perfil...</h3>
                    <div class="loading-icon">⏳</div>
                </div>

                <!-- Profile Content -->
                <div id="profile-container" class="profile-container hidden">
                    <!-- SIDEBAR -->
                    <div class="profile-sidebar">
                        <div class="brand-logo">
                            <div class="brand-icon">✓</div>
                            <span class="brand-text">CheckNote</span>
                        </div>

                        <nav class="sidebar-nav">
                            <button id="nav-personal" class="nav-button active">
                                INFO. PERSONAL
                            </button>
                            <button id="nav-cuenta" class="nav-button">
                                INFO. CUENTA
                            </button>
                            <button id="nav-manejo" class="nav-button">
                                MANEJO
                            </button>
                            <button id="nav-logout" class="nav-button danger">
                                CERRAR SESIÓN
                            </button>
                        </nav>
                    </div>

                    <!-- CONTENIDO -->
                    <div class="profile-content">
                        <!-- Mensajes -->
                        <div id="error-message" class="error-message hidden"></div>
                        <div id="success-message" class="success-message hidden"></div>

                        <!-- INFO. PERSONAL -->
                        <div id="section-personal" class="fade-in">
                            <h2 class="section-header">INFO. PERSONAL</h2>
                            <p class="section-description">
                                Aquí puedes actualizar tu información personal básica
                            </p>

                            <form id="form-personal" class="form">
                                <div class="form-grid-2">
                                    <div class="form-field">
                                        <label class="form-label" for="input-nombres">NOMBRE</label>
                                        <input
                                            type="text"
                                            id="input-nombres"
                                            name="nombres"
                                            placeholder="Tu nombre"
                                            class="form-input"
                                            required
                                        />
                                    </div>
                                    <div class="form-field">
                                        <label class="form-label" for="input-apellidos">APELLIDO</label>
                                        <input
                                            type="text"
                                            id="input-apellidos"
                                            name="apellidos"
                                            placeholder="Tus apellidos"
                                            class="form-input"
                                            required
                                        />
                                    </div>
                                </div>

                                <div class="form-field">
                                    <label class="form-label" for="input-edad">EDAD</label>
                                    <input
                                        type="number"
                                        id="input-edad"
                                        name="edad"
                                        placeholder="Tu edad"
                                        min="13"
                                        max="120"
                                        class="form-input width-sm"
                                    />
                                </div>

                                <button
                                    type="submit"
                                    id="btn-personal"
                                    class="btn-primary"
                                >
                                    Guardar Cambios
                                </button>
                            </form>
                        </div>

                        <!-- INFO. CUENTA -->
                        <div id="section-cuenta" class="fade-in hidden">
                            <h2 class="section-header">INFO. CUENTA</h2>
                            <p class="section-description">
                                Información importante de tu cuenta y configuración
                            </p>

                            <form id="form-cuenta" class="form">
                                <div class="form-field">
                                    <label class="form-label" for="input-email">CORREO</label>
                                    <input
                                        type="email"
                                        id="input-email"
                                        name="email"
                                        placeholder="tu@email.com"
                                        class="form-input width-md"
                                        required
                                    />
                                </div>

                                <div class="form-field">
                                    <label class="form-label" for="input-fecha">CREADO EL</label>
                                    <input
                                        type="date"
                                        id="input-fecha"
                                        disabled
                                        class="form-input width-sm"
                                    />
                                </div>

                                <button
                                    type="submit"
                                    id="btn-cuenta"
                                    class="btn-primary"
                                >
                                    Actualizar Email
                                </button>
                            </form>
                        </div>

                        <!-- MANEJO -->
                        <div id="section-manejo" class="fade-in hidden">
                            <h2 class="section-header">MANEJO</h2>
                            <p class="section-description">
                                Configuraciones sensibles de seguridad y cuenta
                            </p>

                            <form id="form-manejo" class="form">
                                <div class="form-field">
                                    <label class="form-label" for="input-current-password">CONTRASEÑA ACTUAL</label>
                                    <input
                                        type="password"
                                        id="input-current-password"
                                        name="currentPassword"
                                        placeholder="Tu contraseña actual"
                                        class="form-input width-sm"
                                        required
                                    />
                                </div>

                                <div class="form-field">
                                    <label class="form-label" for="input-password">NUEVA CONTRASEÑA</label>
                                    <input
                                        type="password"
                                        id="input-password"
                                        name="password"
                                        placeholder="Nueva contraseña (mín. 8 caracteres)"
                                        class="form-input width-sm"
                                        required
                                        minlength="8"
                                    />
                                </div>

                                <div class="form-field">
                                    <label class="form-label" for="input-confirm-password">CONFIRMAR CONTRASEÑA</label>
                                    <input
                                        type="password"
                                        id="input-confirm-password"
                                        name="confirmPassword"
                                        placeholder="Confirmar nueva contraseña"
                                        class="form-input width-sm"
                                        required
                                    />
                                </div>

                                <button
                                    type="submit"
                                    id="btn-manejo"
                                    class="btn-primary"
                                >
                                    CAMBIAR CONTRASEÑA
                                </button>
                            </form>

                            <div class="danger-zone">
                                <h3 class="danger-zone-title">Zona Peligrosa</h3>
                                <p class="danger-zone-description">
                                    Esta acción eliminará permanentemente tu cuenta y todos tus datos
                                </p>
                                <button
                                    id="btn-delete-account"
                                    class="btn-danger"
                                >
                                    ELIMINAR CUENTA
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- FOOTER -->
        <footer class="footer">
            <a href="home.html" class="footer-link">
                <img src="/home.png" alt="inicio" class="icon" />
                <span class="footer-text">Inicio</span>
            </a>
        </footer>
    </div>

    <script>
        // Variables globales
        let activeSection = "personal";
        let loading = false;
        let loadingData = true;

        // Estados para los formularios
        let personalData = {
            nombres: "",
            apellidos: "",
            edad: ""
        };

        let cuentaData = {
            email: "",
            fechaCreacion: ""
        };

        // Referencias DOM - CORREGIDAS
        const elements = {
            loadingContainer: document.getElementById('loading-container'),
            profileContainer: document.getElementById('profile-container'),
            errorMessage: document.getElementById('error-message'),
            successMessage: document.getElementById('success-message'),
            topbarUsername: document.getElementById('topbar-username'),
            
            // Navegación
            navPersonal: document.getElementById('nav-personal'),
            navCuenta: document.getElementById('nav-cuenta'),
            navManejo: document.getElementById('nav-manejo'),
            navLogout: document.getElementById('nav-logout'),
            
            // Secciones
            sectionPersonal: document.getElementById('section-personal'),
            sectionCuenta: document.getElementById('section-cuenta'),
            sectionManejo: document.getElementById('section-manejo'),
            
            // Formularios
            formPersonal: document.getElementById('form-personal'),
            formCuenta: document.getElementById('form-cuenta'),
            formManejo: document.getElementById('form-manejo'),
            
            // Botones
            btnPersonal: document.getElementById('btn-personal'),
            btnCuenta: document.getElementById('btn-cuenta'),
            btnManejo: document.getElementById('btn-manejo'),
            btnDeleteAccount: document.getElementById('btn-delete-account'),
            
            // Inputs
            inputNombres: document.getElementById('input-nombres'),
            inputApellidos: document.getElementById('input-apellidos'),
            inputEdad: document.getElementById('input-edad'),
            inputEmail: document.getElementById('input-email'),
            inputFecha: document.getElementById('input-fecha'),
            inputCurrentPassword: document.getElementById('input-current-password'),
            inputPassword: document.getElementById('input-password'),
            inputConfirmPassword: document.getElementById('input-confirm-password')
        };

        // Funciones utilitarias
        function showMessage(type, message, duration = 5000) {
            hideMessage('error');
            hideMessage('success');
            
            const messageEl = elements[type + 'Message'];
            if (messageEl) {
                messageEl.textContent = message;
                messageEl.classList.remove('hidden');
                
                if (duration > 0) {
                    setTimeout(() => hideMessage(type), duration);
                }
            }
        }

        function hideMessage(type) {
            const messageEl = elements[type + 'Message'];
            if (messageEl) {
                messageEl.classList.add('hidden');
            }
        }

        function setLoading(buttonElement, isLoading) {
            if (!buttonElement) return;
            
            if (isLoading) {
                buttonElement.disabled = true;
                buttonElement.textContent = buttonElement.textContent.includes('Guardando') ? 'Guardando...' :
                                          buttonElement.textContent.includes('Actualizar') ? 'Actualizando...' :
                                          buttonElement.textContent.includes('CAMBIAR') ? 'Cambiando...' : 'Procesando...';
            } else {
                buttonElement.disabled = false;
                // Restaurar texto original
                if (buttonElement === elements.btnPersonal) buttonElement.textContent = 'Guardar Cambios';
                if (buttonElement === elements.btnCuenta) buttonElement.textContent = 'Actualizar Email';
                if (buttonElement === elements.btnManejo) buttonElement.textContent = 'CAMBIAR CONTRASEÑA';
            }
        }

        function showSection(sectionName) {
            console.log('Switching to section:', sectionName);
            
            // Verificar que los elementos existen
            if (!elements.sectionPersonal || !elements.sectionCuenta || !elements.sectionManejo) {
                console.error('Some section elements are missing');
                return;
            }

            // Ocultar todas las secciones
            elements.sectionPersonal.classList.add('hidden');
            elements.sectionCuenta.classList.add('hidden');
            elements.sectionManejo.classList.add('hidden');
            
            // Desactivar todos los botones de navegación
            elements.navPersonal.classList.remove('active');
            elements.navCuenta.classList.remove('active');
            elements.navManejo.classList.remove('active');
            
            // Mostrar la sección activa
            activeSection = sectionName;
            const targetSection = elements[`section-${sectionName}`];
            const targetNav = elements[`nav-${sectionName}`];
            
            if (targetSection && targetNav) {
                targetSection.classList.remove('hidden');
                targetNav.classList.add('active');
            }
            
            // Limpiar mensajes
            hideMessage('error');
            hideMessage('success');
        }

        // Función para cargar datos del usuario desde la API
        async function cargarDatosUsuario() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                loadingData = true;
                hideMessage('error');

                console.log("Cargando datos del usuario...");
                
                const response = await fetch("https://checknote-27fe.onrender.com/api/v1/users/me", {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json",
                    },
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.clear();
                        showMessage('error', "Tu sesión ha expirado. Redirigiendo al login...");
                        setTimeout(() => window.location.href = 'login.html', 2000);
                        return;
                    }
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const responseData = await response.json();
                console.log("Response from /users/me:", responseData);
                
                // Extraer datos del usuario
                let userData = responseData.data?.usuario || responseData.user || responseData.usuario || responseData;
                
                if (!userData.nombres && responseData.data) {
                    userData = responseData.data;
                }
                
                console.log("USER data extracted:", userData);

                // Formatear fechas
                const fechaCreacion = userData.createdAt || userData.fechaRegistro ? 
                    new Date(userData.createdAt || userData.fechaRegistro).toISOString().split('T')[0] : 
                    new Date().toISOString().split('T')[0];

                personalData = {
                    nombres: userData.nombres || "",
                    apellidos: userData.apellidos || "",
                    edad: userData.edad ? userData.edad.toString() : ""
                };

                cuentaData = {
                    email: userData.correo || userData.email || "",
                    fechaCreacion
                };

                console.log("Final state data:", { personalData, cuentaData });

                // Actualizar UI
                updateFormInputs();

                // Actualizar localStorage
                localStorage.setItem('userName', userData.nombres || "");
                localStorage.setItem('user', JSON.stringify(userData));
                elements.topbarUsername.textContent = userData.nombres || 'Usuario';

            } catch (err) {
                console.error("Error cargando datos:", err);
                showMessage('error', "Error al cargar los datos: " + err.message);
            } finally {
                loadingData = false;
                elements.loadingContainer.classList.add('hidden');
                elements.profileContainer.classList.remove('hidden');
            }
        }

        function updateFormInputs() {
            // Actualizar inputs de información personal
            if (elements.inputNombres) elements.inputNombres.value = personalData.nombres;
            if (elements.inputApellidos) elements.inputApellidos.value = personalData.apellidos;
            if (elements.inputEdad) elements.inputEdad.value = personalData.edad;
            
            // Actualizar inputs de información de cuenta
            if (elements.inputEmail) elements.inputEmail.value = cuentaData.email;
            if (elements.inputFecha) elements.inputFecha.value = cuentaData.fechaCreacion;
        }

        async function makeRequest(endpoint, data) {
            const token = localStorage.getItem('token');
            if (!token) {
                showMessage('error', "No se encontró token de autenticación");
                window.location.href = 'login.html';
                return null;
            }

            console.log('Making request to:', endpoint);
            console.log('Request data:', data);

            const response = await fetch(`https://checknote-27fe.onrender.com/api/v1${endpoint}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`,
                },
                body: JSON.stringify(data),
            });

            console.log('Response status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.log('Error response:', errorText);
                
                if (response.status === 401) {
                    localStorage.clear();
                    showMessage('error', "Tu sesión ha expirado. Redirigiendo al login...");
                    setTimeout(() => window.location.href = 'login.html', 2000);
                    return null;
                }
                
                try {
                    const errorData = JSON.parse(errorText);
                    throw new Error(errorData.message || errorData.error || `Error ${response.status}`);
                } catch (parseError) {
                    throw new Error(`Error ${response.status}: ${errorText || response.statusText}`);
                }
            }

            try {
                const responseText = await response.text();
                return responseText ? JSON.parse(responseText) : {};
            } catch (parseError) {
                return { success: true };
            }
        }

        // Event handlers para formularios
        if (elements.formPersonal) {
            elements.formPersonal.addEventListener('submit', async (e) => {
                e.preventDefault();
                loading = true;
                setLoading(elements.btnPersonal, true);
                hideMessage('error');
                hideMessage('success');

                try {
                    const nombres = elements.inputNombres.value.trim();
                    const apellidos = elements.inputApellidos.value.trim();
                    const edad = elements.inputEdad.value.trim();

                    if (!nombres) throw new Error("El nombre es requerido");
                    if (!apellidos) throw new Error("Los apellidos son requeridos");

                    const updateData = { nombres, apellidos };

                    if (edad) {
                        const edadNum = parseInt(edad);
                        if (isNaN(edadNum) || edadNum < 13 || edadNum > 120) {
                            throw new Error("La edad debe ser un número válido entre 13 y 120");
                        }
                        updateData.edad = edadNum;
                    }
                    
                    await makeRequest('/users/me', updateData);
                    
                    personalData.nombres = nombres;
                    personalData.apellidos = apellidos;
                    personalData.edad = edad;
                    
                    localStorage.setItem('userName', nombres);
                    elements.topbarUsername.textContent = nombres;
                    
                    await cargarDatosUsuario();
                    showMessage('success', "Información personal actualizada correctamente");
                } catch (err) {
                    showMessage('error', "Error al actualizar: " + err.message);
                } finally {
                    loading = false;
                    setLoading(elements.btnPersonal, false);
                }
            });
        }

        if (elements.formCuenta) {
            elements.formCuenta.addEventListener('submit', async (e) => {
                e.preventDefault();
                loading = true;
                setLoading(elements.btnCuenta, true);
                hideMessage('error');
                hideMessage('success');

                try {
                    const email = elements.inputEmail.value.trim();
                    
                    if (!email) throw new Error("El correo electrónico es requerido");

                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        throw new Error("Por favor ingresa un correo electrónico válido");
                    }

                    await makeRequest('/users/me', { correo: email.toLowerCase() });
                    
                    cuentaData.email = email.toLowerCase();
                    await cargarDatosUsuario();
                    showMessage('success', "Email actualizado correctamente");
                } catch (err) {
                    showMessage('error', "Error al actualizar email: " + err.message);
                } finally {
                    loading = false;
                    setLoading(elements.btnCuenta, false);
                }
            });
        }

        if (elements.formManejo) {
            elements.formManejo.addEventListener('submit', async (e) => {
                e.preventDefault();
                loading = true;
                setLoading(elements.btnManejo, true);
                hideMessage('error');
                hideMessage('success');

                try {
                    const currentPassword = elements.inputCurrentPassword.value;
                    const password = elements.inputPassword.value;
                    const confirmPassword = elements.inputConfirmPassword.value;

                    if (!currentPassword) throw new Error("Debes ingresar tu contraseña actual");
                    if (!password) throw new Error("Debes ingresar una nueva contraseña");
                    if (password !== confirmPassword) throw new Error("Las contraseñas no coinciden");
                    if (password.length < 8) throw new Error("La contraseña debe tener al menos 8 caracteres");
                    if (currentPassword === password) throw new Error("La nueva contraseña debe ser diferente");

                    const updateData = {
                        contrasenaActual: currentPassword,
                        nuevaContrasena: password,
                        confirmarNuevaContrasena: confirmPassword
                    };

                    await makeRequest('/users/me', updateData);
                    
                    showMessage('success', "Contraseña cambiada correctamente");
                    
                    elements.inputCurrentPassword.value = "";
                    elements.inputPassword.value = "";
                    elements.inputConfirmPassword.value = "";
                    
                } catch (err) {
                    showMessage('error', "Error al cambiar contraseña: " + err.message);
                } finally {
                    loading = false;
                    setLoading(elements.btnManejo, false);
                }
            });
        }

        // Event listeners para navegación
        if (elements.navPersonal) elements.navPersonal.addEventListener('click', () => showSection('personal'));
        if (elements.navCuenta) elements.navCuenta.addEventListener('click', () => showSection('cuenta'));
        if (elements.navManejo) elements.navManejo.addEventListener('click', () => showSection('manejo'));
        
        if (elements.navLogout) {
            elements.navLogout.addEventListener('click', () => {
                localStorage.clear();
                window.location.href = 'login.html';
            });
        }

        if (elements.btnDeleteAccount) {
            elements.btnDeleteAccount.addEventListener('click', () => {
                if (confirm('¿Estás seguro de que quieres eliminar tu cuenta? Esta acción no se puede deshacer.')) {
                    // Aquí iría la lógica para eliminar cuenta
                    alert('Funcionalidad de eliminación de cuenta pendiente de implementar');
                }
            });
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, inicializando perfil...');
            
            // Verificar que todos los elementos existen
            console.log('Elements check:', {
                loadingContainer: !!elements.loadingContainer,
                profileContainer: !!elements.profileContainer,
                sectionPersonal: !!elements.sectionPersonal,
                sectionCuenta: !!elements.sectionCuenta,
                sectionManejo: !!elements.sectionManejo
            });

            // Cargar datos del usuario
            const storedUserName = localStorage.getItem('userName');
            if (storedUserName && elements.topbarUsername) {
                elements.topbarUsername.textContent = storedUserName;
            }

            // Cargar datos desde la API
            cargarDatosUsuario();
        });
    </script>
</body>
</html>