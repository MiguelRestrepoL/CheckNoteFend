<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil - CheckNote</title>
    <style>
        /* ============================================
           RESET Y BASE
           ============================================ */
        * { 
          box-sizing: border-box; 
          margin: 0; 
          padding: 0; 
        }

        html, body { 
          height: 100%; 
        }

        body {
          font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(180deg, #0b1220 0%, #0f172a 100%);
          color: #ffffff;
          overflow-x: hidden;
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
        }

        /* ============================================
           VARIABLES
           ============================================ */
        :root {
          --primary: #10b981;
          --primary-dark: #059669;
          
          --bg-topbar: #0b1220;
          --bg-card: #1f2937;
          --bg-filter: #111827;
          --bg-input: #374151;
          
          --text-primary: #ffffff;
          --text-secondary: rgba(255,255,255,0.95);
          --text-muted: rgba(255,255,255,0.6);
          --text-dark: #111827;
          
          --border-color: rgba(255,255,255,0.1);
          
          --shadow-topbar: 0 2px 6px rgba(0,0,0,0.25);
          --shadow-card: 0 8px 16px rgba(0, 0, 0, 0.4);
          
          --spacing-xs: 6px;
          --spacing-sm: 8px;
          --spacing-md: 12px;
          --spacing-lg: 16px;
          --spacing-xl: 20px;
          --spacing-2xl: 28px;
          --spacing-3xl: 32px;
          
          --radius-sm: 10px;
          --radius-md: 14px;
          --radius-lg: 999px;
          
          --icon-md: 26px;
          --icon-sm: 20px;
          
          --transition: 0.2s ease;
        }

        /* ============================================
           LAYOUT PRINCIPAL
           ============================================ */
        .page-root { 
          min-height: 100vh; 
          display: flex; 
          flex-direction: column; 
        }

        /* ============================================
           TOPBAR
           ============================================ */
        .topbar {
          width: 100%;
          display: grid;
          grid-template-columns: 1fr auto 1fr;
          align-items: center;
          padding: 14px var(--spacing-2xl);
          background: var(--bg-topbar);
          gap: var(--spacing-md);
          box-shadow: var(--shadow-topbar);
        }

        .topbar-left, 
        .topbar-right { 
          display: flex; 
          align-items: center; 
          gap: var(--spacing-sm); 
        }

        .topbar-left { 
          justify-self: start; 
        }

        .topbar-right { 
          justify-self: end; 
        }

        .topbar-center { 
          justify-self: center; 
        }

        .icon { 
          width: var(--icon-md); 
          height: var(--icon-md); 
          display: block; 
          cursor: pointer;
          transition: opacity var(--transition);
        }

        .icon:hover {
          opacity: 0.8;
        }

        .user-icon { 
          filter: brightness(0) invert(1); 
        }

        .username {
          color: var(--text-primary);
          font-size: 14px;
          font-weight: 500;
        }

        /* ============================================
           BUSCADOR
           ============================================ */
        .search-wrap {
          display: flex;
          align-items: center;
          background: #ffffff;
          color: var(--text-dark);
          border-radius: var(--radius-lg);
          padding: var(--spacing-xs) var(--spacing-sm);
          width: 420px;
          max-width: 56vw;
          box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .search-icon { 
          margin-right: var(--spacing-sm); 
          opacity: 0.7; 
          width: var(--icon-sm);
          height: var(--icon-sm);
        }

        .search-input {
          border: none;
          outline: none;
          width: 100%;
          background: transparent;
          font-size: 14px;
          padding: var(--spacing-xs) 4px;
          color: var(--text-dark);
        }

        .search-input::placeholder {
          color: rgba(0,0,0,0.5);
        }

        /* ============================================
           MAIN CONTENT
           ============================================ */
        .main {
          flex: 1;
          display: flex;
          justify-content: center;
          padding: var(--spacing-3xl) var(--spacing-lg);
        }

        .center-column {
          width: 100%;
          max-width: 1000px;
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 0;
        }

        /* ============================================
           LAYOUT DE PERFIL
           ============================================ */
        .profile-container {
          display: grid;
          grid-template-columns: 280px 1fr;
          gap: var(--spacing-xl);
          width: 100%;
          align-items: start;
        }

        .profile-sidebar {
          display: flex;
          flex-direction: column;
          gap: var(--spacing-lg);
        }

        .profile-content {
          background: var(--bg-card);
          border-radius: var(--radius-md);
          padding: var(--spacing-xl);
          box-shadow: var(--shadow-card);
          color: var(--text-primary);
          text-align: left;
          min-height: 500px;
          width: 100%;
        }

        /* ============================================
           LOGO Y BRANDING
           ============================================ */
        .brand-logo {
          display: flex;
          align-items: center;
          gap: var(--spacing-sm);
          margin-bottom: var(--spacing-lg);
        }

        .brand-icon {
          width: 40px;
          height: 40px;
          background: var(--primary);
          border-radius: var(--radius-sm);
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 20px;
          font-weight: bold;
          color: white;
        }

        .brand-text {
          font-size: 20px;
          font-weight: bold;
          color: var(--primary);
        }

        /* ============================================
           NAVEGACIÓN DE SIDEBAR
           ============================================ */
        .sidebar-nav {
          display: flex;
          flex-direction: column;
          gap: var(--spacing-sm);
        }

        .nav-button {
          padding: 12px 24px;
          border-radius: var(--radius-sm);
          border: none;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: all var(--transition);
          background: var(--bg-filter);
          color: var(--text-primary);
          text-align: left;
          justify-content: flex-start;
        }

        .nav-button:hover {
          opacity: 0.9;
          transform: translateY(-1px);
        }

        .nav-button.active {
          background: var(--primary);
          color: white;
        }

        .nav-button.danger {
          background: linear-gradient(135deg, #ef4444, #dc2626);
          color: white;
          margin-top: var(--spacing-lg);
          text-align: center;
        }

        /* ============================================
           FORMULARIOS - SISTEMA CORREGIDO
           ============================================ */
        .form-container {
          display: flex;
          flex-direction: column;
          gap: var(--spacing-xl);
          width: 100%;
          padding: var(--spacing-md) 0;
        }

        .form-field {
          display: flex;
          flex-direction: column;
          gap: var(--spacing-sm);
          width: 100%;
        }

        /* LABELS Y INPUTS - MISMO ANCHO */
        .form-label {
          background: rgba(255,255,255,0.9) !important;
          color: var(--text-dark) !important;
          padding: 8px 12px !important;
          border-radius: 4px !important;
          font-size: 12px !important;
          font-weight: bold !important;
          text-align: center !important;
          text-transform: uppercase !important;
          box-sizing: border-box !important;
          margin-bottom: 4px !important;
          display: block !important;
          width: 100% !important;
        }

        .form-input {
          padding: 12px 16px;
          border-radius: var(--radius-sm);
          border: 1px solid var(--border-color);
          background: rgba(255,255,255,0.05);
          color: var(--text-primary);
          font-size: 14px;
          outline: none;
          transition: all var(--transition);
          box-sizing: border-box;
          width: 100%;
        }

        .form-input:focus {
          border-color: rgba(16, 185, 129, 0.5);
          box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .form-input:disabled {
          opacity: 0.6;
          cursor: not-allowed;
          background: rgba(255,255,255,0.05);
          color: var(--text-muted);
        }

        .form-input::placeholder {
          color: rgba(255,255,255,0.5);
        }

        /* Contenedores con ancho específico para que label e input coincidan */
        .form-field.width-sm {
          max-width: 300px;
        }

        .form-field.width-md {
          max-width: 400px;
        }

        /* ============================================
           BOTONES DE ACCIÓN
           ============================================ */
        .action-button {
          padding: 12px 24px;
          border-radius: var(--radius-sm);
          border: none;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: all var(--transition);
          box-sizing: border-box;
          text-align: center;
          margin: 0 auto;
          max-width: 400px;
          width: 100%;
        }

        .action-button.primary {
          background: linear-gradient(135deg, var(--primary), var(--primary-dark));
          color: white;
        }

        .action-button.info {
          background: linear-gradient(135deg, #3b82f6, #1d4ed8);
          color: white;
        }

        .action-button.danger {
          background: linear-gradient(135deg, #ef4444, #dc2626);
          color: white;
          display: block;
        }

        .action-button.loading {
          background: linear-gradient(135deg, #6b7280, #4b5563);
          cursor: not-allowed;
          opacity: 0.8;
        }

        .action-button:hover:not(.loading) {
          transform: translateY(-1px);
          opacity: 0.95;
        }

        .action-button:disabled {
          cursor: not-allowed;
        }

        /* ============================================
           MENSAJES DE ESTADO
           ============================================ */
        .status-message {
          padding: 12px;
          border-radius: var(--radius-sm);
          font-size: 14px;
          text-align: center;
          font-weight: 500;
          margin-bottom: var(--spacing-lg);
          width: 100%;
          box-sizing: border-box;
        }

        .status-message.error {
          background: linear-gradient(135deg, #ef4444, #dc2626);
          color: white;
        }

        .status-message.success {
          background: linear-gradient(135deg, var(--primary), var(--primary-dark));
          color: white;
        }

        .status-message.warning {
          background: linear-gradient(135deg, #f59e0b, #d97706);
          color: white;
        }

        .status-message.info {
          background: linear-gradient(135deg, #3b82f6, #1d4ed8);
          color: white;
        }

        /* ============================================
           SECCIONES
           ============================================ */
        .section-header {
          margin-bottom: var(--spacing-sm);
          font-size: 18px;
          font-weight: 700;
        }

        .section-description {
          color: var(--text-muted);
          font-size: 14px;
          margin-bottom: var(--spacing-xl);
        }

        .danger-zone {
          border-top: 1px solid rgba(255,255,255,0.1);
          padding-top: var(--spacing-xl);
          margin-top: var(--spacing-xl);
          width: 100%;
          box-sizing: border-box;
          text-align: center;
        }

        .danger-zone-title {
          color: #ef4444;
          margin-bottom: var(--spacing-md);
          font-size: 16px;
          font-weight: bold;
        }

        .danger-zone-description {
          color: var(--text-muted);
          font-size: 14px;
          margin-bottom: var(--spacing-lg);
          line-height: 1.5;
          max-width: 500px;
          margin-left: auto;
          margin-right: auto;
          margin-bottom: var(--spacing-lg);
        }

        /* ============================================
           ESTADOS DE CARGA
           ============================================ */
        .loading-container {
          text-align: center;
          padding: 40px;
          background: var(--bg-card);
          border-radius: var(--radius-md);
          box-shadow: var(--shadow-card);
        }

        .loading-icon {
          margin-top: 20px;
          font-size: 24px;
          animation: rotate 2s linear infinite;
        }

        @keyframes rotate {
          from {
            transform: rotate(0deg);
          }
          to {
            transform: rotate(360deg);
          }
        }

        /* ============================================
           VISIBILIDAD DE SECCIONES
           ============================================ */
        #section-personal,
        #section-cuenta,
        #section-manejo {
          width: 100%;
          display: block;
        }

        #section-personal.hidden,
        #section-cuenta.hidden,
        #section-manejo.hidden {
          display: none;
        }

        .fade-in {
          animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }

        /* ============================================
           FOOTER
           ============================================ */
        .footer {
          width: 100%;
          background: var(--bg-topbar);
          padding: var(--spacing-md) 0;
          display: flex; 
          justify-content: center; 
          align-items: center; 
          gap: var(--spacing-sm);
          border-top: 1px solid rgba(255,255,255,0.02);
        }

        .footer-link {
          display: flex;
          align-items: center;
          gap: var(--spacing-xs);
          text-decoration: none;
          color: var(--text-primary);
          transition: opacity var(--transition);
        }

        .footer-link:hover {
          opacity: 0.8;
        }

        .footer-text {
          font-size: 12px;
          color: var(--text-muted);
        }

        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 768px) {
          .profile-container {
            grid-template-columns: 1fr;
            gap: var(--spacing-lg);
          }
          
          .profile-sidebar {
            order: 2;
          }
          
          .profile-content {
            order: 1;
          }
          
          .brand-logo {
            justify-content: center;
          }
          
          .sidebar-nav {
            flex-direction: row;
            overflow-x: auto;
            gap: var(--spacing-xs);
            padding-bottom: var(--spacing-sm);
          }
          
          .nav-button {
            min-width: 120px;
            text-align: center;
          }
          
          .nav-button.danger {
            margin-top: 0;
            margin-left: var(--spacing-lg);
          }
          
          .form-field.width-sm,
          .form-field.width-md {
            max-width: none;
          }
          
          .topbar {
            padding: 14px var(--spacing-lg);
          }
          
          .search-wrap { 
            width: 300px; 
            max-width: 60vw; 
          }
        }

        @media (max-width: 600px) {
          .topbar { 
            grid-template-columns: 1fr; 
            gap: var(--spacing-sm); 
            padding: var(--spacing-md); 
          }
          
          .topbar-right { 
            justify-self: start; 
          }
          
          .topbar-left { 
            justify-self: start; 
          }
          
          .topbar-center { 
            justify-self: stretch; 
            display: flex; 
            justify-content: center; 
          }
          
          .search-wrap { 
            width: 100%; 
            max-width: 360px; 
          }
          
          .main {
            padding: var(--spacing-xl) var(--spacing-sm);
          }
          
          .center-column {
            gap: var(--spacing-lg);
          }
          
          .profile-content {
            padding: var(--spacing-lg);
          }
        }

        .hidden { display: none; }
        .mb-xl { margin-bottom: var(--spacing-xl); }
    </style>
</head>
<body>
    <div class="page-root">
        <!-- TOPBAR -->
        <header class="topbar">
            <div class="topbar-left">
                <div style="width: 26px; height: 26px; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">U</div>
                <span class="username" id="topbar-username">Testing123</span>
            </div>
            <div class="topbar-center">
                <div class="search-wrap">
                    <div style="width: 20px; height: 20px; background: #666; margin-right: 8px; opacity: 0.7;"></div>
                    <input class="search-input" placeholder="Buscar en configuración..." />
                </div>
            </div>
            <div class="topbar-right">
                <a href="home.html">
                    <div style="width: 26px; height: 26px; background: #666; cursor: pointer;"></div>
                </a>
            </div>
        </header>

        <!-- MAIN -->
        <main class="main">
            <div class="center-column">
                
                <!-- Loading Screen -->
                <div id="loading-container" class="loading-container hidden">
                    <h3>Cargando tu perfil...</h3>
                    <div class="loading-icon">⏳</div>
                </div>

                <!-- Profile Content -->
                <div id="profile-container" class="profile-container">
                    <!-- SIDEBAR -->
                    <div class="profile-sidebar">
                        <div class="brand-logo">
                            <div class="brand-icon">✓</div>
                            <span class="brand-text">Checknote</span>
                        </div>

                        <nav class="sidebar-nav">
                            <button id="nav-personal" class="nav-button active">
                                INFO. PERSONAL
                            </button>
                            <button id="nav-cuenta" class="nav-button">
                                INFO. CUENTA
                            </button>
                            <button id="nav-manejo" class="nav-button">
                                MANEJO
                            </button>
                            <button id="nav-logout" class="nav-button danger">
                                CERRAR SESIÓN
                            </button>
                        </nav>
                    </div>

                    <!-- CONTENIDO -->
                    <div class="profile-content">
                        <!-- Mensajes -->
                        <div id="error-message" class="status-message error hidden"></div>
                        <div id="success-message" class="status-message success hidden"></div>

                        <!-- INFO. PERSONAL -->
                        <div id="section-personal" class="fade-in">
                            <h2 class="section-header">INFO. PERSONAL</h2>
                            <p class="section-description">
                                Aquí puedes actualizar tu información personal básica
                            </p>

                            <form id="form-personal" class="form-container">
                                <div class="form-field width-md">
                                    <div class="form-label">NOMBRE ✏️</div>
                                    <input
                                        type="text"
                                        id="input-nombres"
                                        name="nombres"
                                        placeholder="Tu nombre"
                                        class="form-input"
                                        value="Testing123"
                                        required
                                    />
                                </div>
                                
                                <div class="form-field width-md">
                                    <div class="form-label">APELLIDO ✏️</div>
                                    <input
                                        type="text"
                                        id="input-apellidos"
                                        name="apellidos"
                                        placeholder="Tus apellidos"
                                        class="form-input"
                                        value="ADS"
                                        required
                                    />
                                </div>

                                <div class="form-field width-sm">
                                    <div class="form-label">EDAD ✏️</div>
                                    <input
                                        type="number"
                                        id="input-edad"
                                        name="edad"
                                        placeholder="Tu edad"
                                        min="13"
                                        max="120"
                                        class="form-input"
                                        value="20"
                                    />
                                </div>

                                <button
                                    type="submit"
                                    id="btn-personal"
                                    class="action-button primary"
                                >
                                    Guardar Cambios
                                </button>
                            </form>
                        </div>

                        <!-- INFO. CUENTA -->
                        <div id="section-cuenta" class="fade-in hidden">
                            <h2 class="section-header">INFO. CUENTA</h2>
                            <p class="section-description">
                                Información importante de tu cuenta y configuración
                            </p>

                            <form id="form-cuenta" class="form-container">
                                <div class="form-field width-md">
                                    <div class="form-label">CORREO ✏️</div>
                                    <input
                                        type="email"
                                        id="input-email"
                                        name="email"
                                        placeholder="tu@email.com"
                                        class="form-input"
                                        required
                                    />
                                </div>

                                <div class="form-field width-sm">
                                    <div class="form-label">CREADO EL</div>
                                    <input
                                        type="date"
                                        id="input-fecha"
                                        disabled
                                        class="form-input"
                                    />
                                </div>

                                <button
                                    type="submit"
                                    id="btn-cuenta"
                                    class="action-button primary"
                                >
                                    Actualizar Email
                                </button>
                            </form>
                        </div>

                        <!-- MANEJO -->
                        <div id="section-manejo" class="fade-in hidden">
                            <h2 class="section-header">MANEJO</h2>
                            <p class="section-description">
                                Configuraciones sensibles de seguridad y cuenta
                            </p>

                            <form id="form-manejo" class="form-container mb-xl">
                                <div class="form-field width-sm">
                                    <div class="form-label">CONTRASEÑA ACTUAL</div>
                                    <input
                                        type="password"
                                        id="input-current-password"
                                        name="currentPassword"
                                        placeholder="Tu contraseña actual"
                                        class="form-input"
                                        required
                                    />
                                </div>

                                <div class="form-field width-sm">
                                    <div class="form-label">NUEVA CONTRASEÑA</div>
                                    <input
                                        type="password"
                                        id="input-password"
                                        name="password"
                                        placeholder="Nueva contraseña (mín. 8 caracteres)"
                                        class="form-input"
                                        required
                                        minlength="8"
                                    />
                                </div>

                                <div class="form-field width-sm">
                                    <div class="form-label">CONFIRMAR CONTRASEÑA</div>
                                    <input
                                        type="password"
                                        id="input-confirm-password"
                                        name="confirmPassword"
                                        placeholder="Confirmar nueva contraseña"
                                        class="form-input"
                                        required
                                    />
                                </div>

                                <button
                                    type="submit"
                                    id="btn-manejo"
                                    class="action-button info"
                                >
                                    CAMBIAR CONTRASEÑA
                                </button>
                            </form>

                            <div class="danger-zone">
                                <h3 class="danger-zone-title">Zona Peligrosa</h3>
                                <p class="danger-zone-description">
                                    Esta acción eliminará permanentemente tu cuenta y todos tus datos
                                </p>
                                <button
                                    id="btn-delete-account"
                                    class="action-button danger"
                                >
                                    ELIMINAR CUENTA
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- FOOTER -->
        <footer class="footer">
            <a href="home.html" class="footer-link">
                <div style="width: 26px; height: 26px; background: #666;"></div>
                <span class="footer-text">Inicio</span>
            </a>
        </footer>
    </div>

    <script>
        // Variables globales
        let activeSection = "personal";
        let loading = false;
        let loadingData = true;

        // Estados para los formularios
        let personalData = {
            nombres: "",
            apellidos: "",
            edad: ""
        };

        let cuentaData = {
            email: "",
            fechaCreacion: ""
        };

        let manejoData = {
            currentPassword: "",
            password: "",
            confirmPassword: ""
        };

        // Referencias DOM
        const elements = {};

        // Función para inicializar las referencias DOM
        function initializeElements() {
            // Elementos principales
            elements.loadingContainer = document.getElementById('loading-container');
            elements.profileContainer = document.getElementById('profile-container');
            elements.errorMessage = document.getElementById('error-message');
            elements.successMessage = document.getElementById('success-message');
            elements.topbarUsername = document.getElementById('topbar-username');
            
            // Navegación
            elements.navPersonal = document.getElementById('nav-personal');
            elements.navCuenta = document.getElementById('nav-cuenta');
            elements.navManejo = document.getElementById('nav-manejo');
            elements.navLogout = document.getElementById('nav-logout');
            
            // Secciones
            elements.sectionPersonal = document.getElementById('section-personal');
            elements.sectionCuenta = document.getElementById('section-cuenta');
            elements.sectionManejo = document.getElementById('section-manejo');
            
            // Formularios
            elements.formPersonal = document.getElementById('form-personal');
            elements.formCuenta = document.getElementById('form-cuenta');
            elements.formManejo = document.getElementById('form-manejo');
            
            // Botones
            elements.btnPersonal = document.getElementById('btn-personal');
            elements.btnCuenta = document.getElementById('btn-cuenta');
            elements.btnManejo = document.getElementById('btn-manejo');
            elements.btnDeleteAccount = document.getElementById('btn-delete-account');
            
            // Inputs
            elements.inputNombres = document.getElementById('input-nombres');
            elements.inputApellidos = document.getElementById('input-apellidos');
            elements.inputEdad = document.getElementById('input-edad');
            elements.inputEmail = document.getElementById('input-email');
            elements.inputFecha = document.getElementById('input-fecha');
            elements.inputCurrentPassword = document.getElementById('input-current-password');
            elements.inputPassword = document.getElementById('input-password');
            elements.inputConfirmPassword = document.getElementById('input-confirm-password');

            console.log('Elements initialized:', Object.keys(elements).length, 'elements found');
        }

        // Funciones utilitarias
        function showMessage(type, message, duration = 5000) {
            hideMessage('error');
            hideMessage('success');
            
            const messageEl = elements[type + 'Message'];
            if (messageEl) {
                messageEl.textContent = message;
                messageEl.classList.remove('hidden');
                
                if (duration > 0) {
                    setTimeout(() => hideMessage(type), duration);
                }
            }
        }

        function hideMessage(type) {
            const messageEl = elements[type + 'Message'];
            if (messageEl) {
                messageEl.classList.add('hidden');
            }
        }

        function setLoading(buttonElement, isLoading) {
            if (!buttonElement) return;
            
            if (isLoading) {
                buttonElement.disabled = true;
                buttonElement.classList.add('loading');
                buttonElement.textContent = buttonElement.textContent.includes('Guardando') ? 'Guardando...' :
                                          buttonElement.textContent.includes('Cambiando') ? 'Cambiando...' :
                                          buttonElement.textContent.includes('Actualizar') ? 'Actualizando...' : 'Procesando...';
            } else {
                buttonElement.disabled = false;
                buttonElement.classList.remove('loading');
                // Restaurar texto original
                if (buttonElement === elements.btnPersonal) buttonElement.textContent = 'Guardar Cambios';
                if (buttonElement === elements.btnCuenta) buttonElement.textContent = 'Actualizar Email';
                if (buttonElement === elements.btnManejo) buttonElement.textContent = 'CAMBIAR CONTRASEÑA';
            }
        }

        // Función showSection
        function showSection(sectionName) {
            console.log('Cambiando a sección:', sectionName);
            
            // Verificar que los elementos existen
            if (!elements.sectionPersonal || !elements.sectionCuenta || !elements.sectionManejo) {
                console.error('Section elements not found');
                return;
            }
            
            // Ocultar todas las secciones
            elements.sectionPersonal.classList.add('hidden');
            elements.sectionCuenta.classList.add('hidden');
            elements.sectionManejo.classList.add('hidden');
            
            // Desactivar todos los botones de navegación
            if (elements.navPersonal) elements.navPersonal.classList.remove('active');
            if (elements.navCuenta) elements.navCuenta.classList.remove('active');
            if (elements.navManejo) elements.navManejo.classList.remove('active');
            
            // Mostrar la sección activa y activar el botón correspondiente
            activeSection = sectionName;
            const targetSection = elements['section' + sectionName.charAt(0).toUpperCase() + sectionName.slice(1)];
            const targetNavButton = elements['nav' + sectionName.charAt(0).toUpperCase() + sectionName.slice(1)];
            
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            
            if (targetNavButton) {
                targetNavButton.classList.add('active');
            }
            
            // Limpiar mensajes
            hideMessage('error');
            hideMessage('success');
        }

        // Función para cargar datos del usuario desde la API
        async function cargarDatosUsuario() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                loadingData = true;
                hideMessage('error');

                console.log("Cargando datos del usuario...");
                
                const response = await fetch("https://checknote-27fe.onrender.com/api/v1/users/me", {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json",
                    },
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.clear();
                        showMessage('error', "Tu sesión ha expirado. Redirigiendo al login...");
                        setTimeout(() => window.location.href = 'login.html', 2000);
                        return;
                    }
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const responseData = await response.json();
                console.log("Response from /users/me:", responseData);
                
                // Extraer datos del usuario
                let userData = responseData.data?.usuario || responseData.user || responseData.usuario || responseData;
                
                if (!userData.nombres && responseData.data) {
                    userData = responseData.data;
                }
                
                console.log("USER data extracted:", userData);

                // Formatear fechas
                const fechaCreacion = userData.createdAt || userData.fechaRegistro ? 
                    new Date(userData.createdAt || userData.fechaRegistro).toISOString().split('T')[0] : 
                    new Date().toISOString().split('T')[0];

                personalData = {
                    nombres: userData.nombres || "",
                    apellidos: userData.apellidos || "",
                    edad: userData.edad ? userData.edad.toString() : ""
                };

                cuentaData = {
                    email: userData.correo || userData.email || "",
                    fechaCreacion
                };

                // Actualizar UI
                updateFormInputs();

                // Actualizar localStorage
                localStorage.setItem('userName', userData.nombres || "");
                localStorage.setItem('user', JSON.stringify(userData));
                if (elements.topbarUsername) {
                    elements.topbarUsername.textContent = userData.nombres || 'Usuario';
                }

            } catch (err) {
                console.error("Error cargando datos:", err);
                showMessage('error', "Error al cargar los datos: " + err.message);
                
                // Fallback a localStorage
                const storedUser = localStorage.getItem('user');
                if (storedUser) {
                    try {
                        const parsedUser = JSON.parse(storedUser);
                        personalData = {
                            nombres: parsedUser.nombres || localStorage.getItem('userName') || "",
                            apellidos: parsedUser.apellidos || "",
                            edad: parsedUser.edad ? parsedUser.edad.toString() : ""
                        };
                        cuentaData = {
                            email: parsedUser.correo || parsedUser.email || "",
                            fechaCreacion: parsedUser.createdAt ? 
                                new Date(parsedUser.createdAt).toISOString().split('T')[0] : 
                                new Date().toISOString().split('T')[0]
                        };
                        updateFormInputs();
                        if (elements.topbarUsername) {
                            elements.topbarUsername.textContent = personalData.nombres || 'Usuario';
                        }
                    } catch (parseError) {
                        console.error('Error parsing stored data:', parseError);
                    }
                }
            } finally {
                loadingData = false;
                if (elements.loadingContainer) elements.loadingContainer.classList.add('hidden');
                if (elements.profileContainer) elements.profileContainer.classList.remove('hidden');
            }
        }

        function updateFormInputs() {
            // Actualizar inputs de información personal
            if (elements.inputNombres) elements.inputNombres.value = personalData.nombres;
            if (elements.inputApellidos) elements.inputApellidos.value = personalData.apellidos;
            if (elements.inputEdad) elements.inputEdad.value = personalData.edad;
            
            // Actualizar inputs de información de cuenta
            if (elements.inputEmail) elements.inputEmail.value = cuentaData.email;
            if (elements.inputFecha) elements.inputFecha.value = cuentaData.fechaCreacion;
        }

        async function makeRequest(endpoint, data, isPasswordChange = false) {
            const token = localStorage.getItem('token');
            if (!token) {
                showMessage('error', "No se encontró token de autenticación");
                window.location.href = 'login.html';
                return null;
            }

            console.log(`Making ${isPasswordChange ? 'password change' : 'update'} request to:`, endpoint);

            const response = await fetch(`https://checknote-27fe.onrender.com/api/v1${endpoint}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`,
                },
                body: JSON.stringify(data),
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                
                try {
                    const errorData = JSON.parse(errorText);
                    
                    if (response.status === 401) {
                        if (errorData.message && errorData.message.toLowerCase().includes("contraseña")) {
                            throw new Error("La contraseña actual es incorrecta");
                        }
                        localStorage.clear();
                        showMessage('error', "Tu sesión ha expirado. Redirigiendo al login...");
                        setTimeout(() => window.location.href = 'login.html', 2000);
                        return null;
                    }
                    
                    throw new Error(errorData.message || errorData.error || `Error ${response.status}`);
                } catch (parseError) {
                    if (parseError.message && parseError.message !== `Unexpected token '<'`) {
                        throw parseError;
                    }
                    throw new Error(`Error ${response.status}: ${errorText || response.statusText}`);
                }
            }

            try {
                const responseText = await response.text();
                return responseText ? JSON.parse(responseText) : {};
            } catch (parseError) {
                return { success: true };
            }
        }

        // Función para agregar event listeners
        function addEventListeners() {
            // Event handlers para formularios
            if (elements.formPersonal) {
                elements.formPersonal.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    loading = true;
                    setLoading(elements.btnPersonal, true);
                    hideMessage('error');
                    hideMessage('success');

                    try {
                        const nombres = elements.inputNombres.value.trim();
                        const apellidos = elements.inputApellidos.value.trim();
                        const edad = elements.inputEdad.value.trim();

                        if (!nombres) {
                            throw new Error("El nombre es requerido");
                        }
                        if (!apellidos) {
                            throw new Error("Los apellidos son requeridos");
                        }

                        const updateData = { nombres, apellidos };

                        if (edad) {
                            const edadNum = parseInt(edad);
                            if (isNaN(edadNum) || edadNum < 13 || edadNum > 120) {
                                throw new Error("La edad debe ser un número válido entre 13 y 120");
                            }
                            updateData.edad = edadNum;
                        }
                        
                        await makeRequest('/users/me', updateData);
                        
                        personalData.nombres = nombres;
                        personalData.apellidos = apellidos;
                        personalData.edad = edad;
                        
                        localStorage.setItem('userName', nombres);
                        elements.topbarUsername.textContent = nombres;
                        
                        await cargarDatosUsuario();
                        
                        showMessage('success', "Información personal actualizada correctamente");
                    } catch (err) {
                        showMessage('error', "Error al actualizar la información personal: " + err.message);
                    } finally {
                        loading = false;
                        setLoading(elements.btnPersonal, false);
                    }
                });
            }

            if (elements.formCuenta) {
                elements.formCuenta.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    loading = true;
                    setLoading(elements.btnCuenta, true);
                    hideMessage('error');
                    hideMessage('success');

                    try {
                        const email = elements.inputEmail.value.trim();
                        
                        if (!email) {
                            throw new Error("El correo electrónico es requerido");
                        }

                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        if (!emailRegex.test(email)) {
                            throw new Error("Por favor ingresa un correo electrónico válido");
                        }

                        const updateData = { 
                            correo: email.toLowerCase() 
                        };
                        
                        await makeRequest('/users/me', updateData);
                        
                        cuentaData.email = email.toLowerCase();
                        
                        await cargarDatosUsuario();
                        
                        showMessage('success', "Información de cuenta actualizada correctamente");
                    } catch (err) {
                        showMessage('error', "Error al actualizar la información de cuenta: " + err.message);
                    } finally {
                        loading = false;
                        setLoading(elements.btnCuenta, false);
                    }
                });
            }

            if (elements.formManejo) {
                elements.formManejo.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    loading = true;
                    setLoading(elements.btnManejo, true);
                    hideMessage('error');
                    hideMessage('success');

                    try {
                        const currentPassword = elements.inputCurrentPassword.value;
                        const password = elements.inputPassword.value;
                        const confirmPassword = elements.inputConfirmPassword.value;

                        if (!currentPassword) {
                            throw new Error("Debes ingresar tu contraseña actual");
                        }
                        if (!password) {
                            throw new Error("Debes ingresar una nueva contraseña");
                        }
                        if (password !== confirmPassword) {
                            throw new Error("Las contraseñas no coinciden");
                        }
                        if (password.length < 8) {
                            throw new Error("La contraseña debe tener al menos 8 caracteres");
                        }
                        if (currentPassword === password) {
                            throw new Error("La nueva contraseña debe ser diferente a la actual");
                        }

                        const updateData = {
                            contrasenaActual: currentPassword,
                            nuevaContrasena: password,
                            confirmarNuevaContrasena: confirmPassword
                        };

                        await makeRequest('/users/me', updateData, true);
                        
                        showMessage('success', "Contraseña cambiada correctamente");
                        
                        elements.inputCurrentPassword.value = "";
                        elements.inputPassword.value = "";
                        elements.inputConfirmPassword.value = "";
                        
                    } catch (err) {
                        showMessage('error', "Error al cambiar la contraseña: " + err.message);
                    } finally {
                        loading = false;
                        setLoading(elements.btnManejo, false);
                    }
                });
            }

            // Event listeners para navegación
            if (elements.navPersonal) {
                elements.navPersonal.addEventListener('click', () => showSection('personal'));
            }
            if (elements.navCuenta) {
                elements.navCuenta.addEventListener('click', () => showSection('cuenta'));
            }
            if (elements.navManejo) {
                elements.navManejo.addEventListener('click', () => showSection('manejo'));
            }
            
            if (elements.navLogout) {
                elements.navLogout.addEventListener('click', () => {
                    localStorage.clear();
                    window.location.href = 'login.html';
                });
            }

            if (elements.btnDeleteAccount) {
                elements.btnDeleteAccount.addEventListener('click', () => {
                    window.location.href = 'eliminar-cuenta.html';
                });
            }
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            
            // Inicializar elementos
            initializeElements();
            
            // Agregar event listeners
            addEventListeners();
            
            // Cargar datos del usuario
            const storedUserName = localStorage.getItem('userName');
            if (storedUserName && elements.topbarUsername) {
                elements.topbarUsername.textContent = storedUserName;
            }

            // Cargar datos desde la API
            cargarDatosUsuario();
        });
    </script>
    </body>
</html>