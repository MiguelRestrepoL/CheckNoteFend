<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil - CheckNote</title>
    <link rel="stylesheet" href="./GlobalCSS3.css">
</head>
<body>
    <div class="page-root">
        <!-- TOPBAR -->
        <header class="topbar">
            <div class="topbar-left">
                <img src="/usuario.png" alt="usuario" class="icon user-icon" />
                <span class="username" id="topbar-username">Usuario</span>
            </div>
            <div class="topbar-center">
                <div class="search-wrap">
                    <img src="/search.png" alt="buscar" class="search-icon" />
                    <input class="search-input" placeholder="Buscar en configuración..." />
                </div>
            </div>
            <div class="topbar-right">
                <a href="home.html">
                    <img src="/back.png" alt="inicio" class="icon" />
                </a>
            </div>
        </header>

        <!-- MAIN -->
        <main class="main">
            <div class="center-column" style="max-width: 1000px; gap: 0">
                
                <!-- Loading Screen -->
                <div id="loading-container" class="loading-container">
                    <h3>Cargando tu perfil...</h3>
                    <div class="loading-icon">⏳</div>
                </div>

                <!-- Profile Content -->
                <div id="profile-container" class="profile-container hidden">
                    <!-- SIDEBAR -->
                    <div class="profile-sidebar">
                        <div class="brand-logo">
                            <div class="brand-icon">✓</div>
                            <span class="brand-text">Checknote</span>
                        </div>

                        <nav class="sidebar-nav">
                            <button id="nav-personal" class="nav-button active">
                                INFO. PERSONAL
                            </button>
                            <button id="nav-cuenta" class="nav-button">
                                INFO. CUENTA
                            </button>
                            <button id="nav-manejo" class="nav-button">
                                MANEJO
                            </button>
                            <button id="nav-logout" class="nav-button danger">
                                CERRAR SESIÓN
                            </button>
                        </nav>
                    </div>

                    <!-- CONTENIDO -->
                    <div class="task-card profile-content">
                        <!-- Mensajes -->
                        <div id="error-message" class="status-message error hidden"></div>
                        <div id="success-message" class="status-message success hidden"></div>

                        <!-- INFO. PERSONAL -->
                        <div id="section-personal" class="fade-in">
                            <h2 class="task-title section-header">INFO. PERSONAL</h2>
                            <p class="section-description">
                                Aquí puedes actualizar tu información personal básica
                            </p>

                            <form id="form-personal" class="form-container">
                                <div class="form-grid-2">
                                    <div class="form-field">
                                        <div class="form-label">NOMBRE ✏️</div>
                                        <input
                                            type="text"
                                            id="input-nombres"
                                            name="nombres"
                                            placeholder="Tu nombre"
                                            class="form-input"
                                            required
                                        />
                                    </div>
                                    <div class="form-field">
                                        <div class="form-label">APELLIDO ✏️</div>
                                        <input
                                            type="text"
                                            id="input-apellidos"
                                            name="apellidos"
                                            placeholder="Tus apellidos"
                                            class="form-input"
                                            required
                                        />
                                    </div>
                                </div>

                                <div class="form-field">
                                    <div class="form-label">EDAD ✏️</div>
                                    <input
                                        type="number"
                                        id="input-edad"
                                        name="edad"
                                        placeholder="Tu edad"
                                        min="13"
                                        max="120"
                                        class="form-input width-sm"
                                    />
                                </div>

                                <button
                                    type="submit"
                                    id="btn-personal"
                                    class="action-button primary"
                                >
                                    Guardar Cambios
                                </button>
                            </form>
                        </div>

                        <!-- INFO. CUENTA -->
                        <div id="section-cuenta" class="fade-in hidden">
                            <h2 class="task-title section-header">INFO. CUENTA</h2>
                            <p class="section-description">
                                Información importante de tu cuenta y configuración
                            </p>

                            <form id="form-cuenta" class="form-container">
                                <div class="form-field">
                                    <div class="form-label">CORREO ✏️</div>
                                    <input
                                        type="email"
                                        id="input-email"
                                        name="email"
                                        placeholder="tu@email.com"
                                        class="form-input width-md"
                                        required
                                    />
                                </div>

                                <div class="form-field">
                                    <div class="form-label">CREADO EL</div>
                                    <input
                                        type="date"
                                        id="input-fecha"
                                        disabled
                                        class="form-input width-sm"
                                    />
                                </div>

                                <button
                                    type="submit"
                                    id="btn-cuenta"
                                    class="action-button primary"
                                >
                                    Actualizar Email
                                </button>
                            </form>
                        </div>

                        <!-- MANEJO -->
                        <div id="section-manejo" class="fade-in hidden">
                            <h2 class="task-title section-header">MANEJO</h2>
                            <p class="section-description">
                                Configuraciones sensibles de seguridad y cuenta
                            </p>

                            <form id="form-manejo" class="form-container mb-xl">
                                <div class="form-field">
                                    <div class="form-label">CONTRASEÑA ACTUAL</div>
                                    <input
                                        type="password"
                                        id="input-current-password"
                                        name="currentPassword"
                                        placeholder="Tu contraseña actual"
                                        class="form-input width-sm"
                                        required
                                    />
                                </div>

                                <div class="form-field">
                                    <div class="form-label">NUEVA CONTRASEÑA</div>
                                    <input
                                        type="password"
                                        id="input-password"
                                        name="password"
                                        placeholder="Nueva contraseña (mín. 8 caracteres)"
                                        class="form-input width-sm"
                                        required
                                        minlength="8"
                                    />
                                </div>

                                <div class="form-field">
                                    <div class="form-label">CONFIRMAR CONTRASEÑA</div>
                                    <input
                                        type="password"
                                        id="input-confirm-password"
                                        name="confirmPassword"
                                        placeholder="Confirmar nueva contraseña"
                                        class="form-input width-sm"
                                        required
                                    />
                                </div>

                                <button
                                    type="submit"
                                    id="btn-manejo"
                                    class="action-button info"
                                >
                                    CAMBIAR CONTRASEÑA
                                </button>
                            </form>

                            <div class="danger-zone">
                                <h3 class="danger-zone-title">Zona Peligrosa</h3>
                                <p class="danger-zone-description">
                                    Esta acción eliminará permanentemente tu cuenta y todos tus datos
                                </p>
                                <button
                                    id="btn-delete-account"
                                    class="action-button danger"
                                >
                                    ELIMINAR CUENTA
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- FOOTER -->
        <footer class="footer">
            <a href="home.html" class="footer-link">
                <img src="/home.png" alt="inicio" class="icon" />
                <span class="footer-text">Inicio</span>
            </a>
        </footer>
    </div>

    <script>
        // Variables globales
        let activeSection = "personal";
        let loading = false;
        let loadingData = true;

        // Estados para los formularios
        let personalData = {
            nombres: "",
            apellidos: "",
            edad: ""
        };

        let cuentaData = {
            email: "",
            fechaCreacion: ""
        };

        let manejoData = {
            currentPassword: "",
            password: "",
            confirmPassword: ""
        };

        // Referencias DOM
        const elements = {
            loadingContainer: document.getElementById('loading-container'),
            profileContainer: document.getElementById('profile-container'),
            errorMessage: document.getElementById('error-message'),
            successMessage: document.getElementById('success-message'),
            topbarUsername: document.getElementById('topbar-username'),
            
            // Navegación
            navPersonal: document.getElementById('nav-personal'),
            navCuenta: document.getElementById('nav-cuenta'),
            navManejo: document.getElementById('nav-manejo'),
            navLogout: document.getElementById('nav-logout'),
            
            // Secciones
            sectionPersonal: document.getElementById('section-personal'),
            sectionCuenta: document.getElementById('section-cuenta'),
            sectionManejo: document.getElementById('section-manejo'),
            
            // Formularios
            formPersonal: document.getElementById('form-personal'),
            formCuenta: document.getElementById('form-cuenta'),
            formManejo: document.getElementById('form-manejo'),
            
            // Botones
            btnPersonal: document.getElementById('btn-personal'),
            btnCuenta: document.getElementById('btn-cuenta'),
            btnManejo: document.getElementById('btn-manejo'),
            btnDeleteAccount: document.getElementById('btn-delete-account'),
            
            // Inputs
            inputNombres: document.getElementById('input-nombres'),
            inputApellidos: document.getElementById('input-apellidos'),
            inputEdad: document.getElementById('input-edad'),
            inputEmail: document.getElementById('input-email'),
            inputFecha: document.getElementById('input-fecha'),
            inputCurrentPassword: document.getElementById('input-current-password'),
            inputPassword: document.getElementById('input-password'),
            inputConfirmPassword: document.getElementById('input-confirm-password')
        };

        // Funciones utilitarias
        function showMessage(type, message, duration = 5000) {
            hideMessage('error');
            hideMessage('success');
            
            const messageEl = elements[type + 'Message'];
            messageEl.textContent = message;
            messageEl.classList.remove('hidden');
            
            if (duration > 0) {
                setTimeout(() => hideMessage(type), duration);
            }
        }

        function hideMessage(type) {
            const messageEl = elements[type + 'Message'];
            messageEl.classList.add('hidden');
        }

        function setLoading(buttonElement, isLoading) {
            if (isLoading) {
                buttonElement.disabled = true;
                buttonElement.classList.add('loading');
                buttonElement.textContent = buttonElement.textContent.includes('Guardando') ? 'Guardando...' :
                                          buttonElement.textContent.includes('Cambiando') ? 'Cambiando...' :
                                          buttonElement.textContent.includes('Actualizar') ? 'Actualizando...' : 'Procesando...';
            } else {
                buttonElement.disabled = false;
                buttonElement.classList.remove('loading');
                // Restaurar texto original
                if (buttonElement === elements.btnPersonal) buttonElement.textContent = 'Guardar Cambios';
                if (buttonElement === elements.btnCuenta) buttonElement.textContent = 'Actualizar Email';
                if (buttonElement === elements.btnManejo) buttonElement.textContent = 'CAMBIAR CONTRASEÑA';
            }
        }

        function showSection(sectionName) {
            // Ocultar todas las secciones
            elements.sectionPersonal.classList.add('hidden');
            elements.sectionCuenta.classList.add('hidden');
            elements.sectionManejo.classList.add('hidden');
            
            // Desactivar todos los botones de navegación
            elements.navPersonal.classList.remove('active');
            elements.navCuenta.classList.remove('active');
            elements.navManejo.classList.remove('active');
            
            // Mostrar la sección activa
            activeSection = sectionName;
            elements[`section-${sectionName}`].classList.remove('hidden');
            elements[`nav-${sectionName}`].classList.add('active');
            
            // Limpiar mensajes
            hideMessage('error');
            hideMessage('success');
        }

        // Función para cargar datos del usuario desde la API
        async function cargarDatosUsuario() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                loadingData = true;
                hideMessage('error');

                console.log("Cargando datos del usuario...");
                
                const response = await fetch("https://checknote-27fe.onrender.com/api/v1/users/me", {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json",
                    },
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.clear();
                        showMessage('error', "Tu sesión ha expirado. Redirigiendo al login...");
                        setTimeout(() => window.location.href = 'login.html', 2000);
                        return;
                    }
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const responseData = await response.json();
                console.log("Response from /users/me:", responseData);
                
                // Extraer datos del usuario
                let userData = responseData.data?.usuario || responseData.user || responseData.usuario || responseData;
                
                if (!userData.nombres && responseData.data) {
                    userData = responseData.data;
                }
                
                console.log("USER data extracted:", userData);
                console.log("Available fields in userData:", Object.keys(userData || {}));

                // Formatear fechas
                const fechaCreacion = userData.createdAt || userData.fechaRegistro ? 
                    new Date(userData.createdAt || userData.fechaRegistro).toISOString().split('T')[0] : 
                    new Date().toISOString().split('T')[0];

                personalData = {
                    nombres: userData.nombres || "",
                    apellidos: userData.apellidos || "",
                    edad: userData.edad ? userData.edad.toString() : ""
                };

                cuentaData = {
                    email: userData.correo || userData.email || "",
                    fechaCreacion
                };

                console.log("Final state data:", { personalData, cuentaData });

                // Actualizar UI
                updateFormInputs();

                // Actualizar localStorage
                localStorage.setItem('userName', userData.nombres || "");
                localStorage.setItem('user', JSON.stringify(userData));
                elements.topbarUsername.textContent = userData.nombres || 'Usuario';

            } catch (err) {
                console.error("Error cargando datos:", err);
                showMessage('error', "Error al cargar los datos: " + err.message);
                
                // Fallback a localStorage
                const storedUser = localStorage.getItem('user');
                if (storedUser) {
                    try {
                        const parsedUser = JSON.parse(storedUser);
                        personalData = {
                            nombres: parsedUser.nombres || localStorage.getItem('userName') || "",
                            apellidos: parsedUser.apellidos || "",
                            edad: parsedUser.edad ? parsedUser.edad.toString() : ""
                        };
                        cuentaData = {
                            email: parsedUser.correo || parsedUser.email || "",
                            fechaCreacion: parsedUser.createdAt ? 
                                new Date(parsedUser.createdAt).toISOString().split('T')[0] : 
                                new Date().toISOString().split('T')[0]
                        };
                        updateFormInputs();
                        elements.topbarUsername.textContent = personalData.nombres || 'Usuario';
                    } catch (parseError) {
                        console.error('Error parsing stored data:', parseError);
                    }
                }
            } finally {
                loadingData = false;
                elements.loadingContainer.classList.add('hidden');
                elements.profileContainer.classList.remove('hidden');
            }
        }

        function updateFormInputs() {
            // Actualizar inputs de información personal
            elements.inputNombres.value = personalData.nombres;
            elements.inputApellidos.value = personalData.apellidos;
            elements.inputEdad.value = personalData.edad;
            
            // Actualizar inputs de información de cuenta
            elements.inputEmail.value = cuentaData.email;
            elements.inputFecha.value = cuentaData.fechaCreacion;
        }

        async function makeRequest(endpoint, data, isPasswordChange = false) {
            const token = localStorage.getItem('token');
            if (!token) {
                showMessage('error', "No se encontró token de autenticación");
                window.location.href = 'login.html';
                return null;
            }

            console.log(`Making ${isPasswordChange ? 'password change' : 'update'} request to:`, endpoint);
            console.log('Request data:', data);

            const response = await fetch(`https://checknote-27fe.onrender.com/api/v1${endpoint}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`,
                },
                body: JSON.stringify(data),
            });

            console.log('Response status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.log('Error response:', errorText);
                
                try {
                    const errorData = JSON.parse(errorText);
                    console.log('Parsed error:', errorData);
                    
                    if (response.status === 401) {
                        if (errorData.message && errorData.message.toLowerCase().includes("contraseña")) {
                            throw new Error("La contraseña actual es incorrecta");
                        }
                        localStorage.clear();
                        showMessage('error', "Tu sesión ha expirado. Redirigiendo al login...");
                        setTimeout(() => window.location.href = 'login.html', 2000);
                        return null;
                    }
                    
                    if (response.status === 400) {
                        if (errorData.message) {
                            throw new Error(errorData.message);
                        }
                        if (errorData.error) {
                            throw new Error(errorData.error);
                        }
                    }
                    
                    throw new Error(errorData.message || errorData.error || `Error ${response.status}`);
                } catch (parseError) {
                    if (parseError.message && parseError.message !== `Unexpected token '<'`) {
                        throw parseError;
                    }
                    throw new Error(`Error ${response.status}: ${errorText || response.statusText}`);
                }
            }

            try {
                const responseText = await response.text();
                return responseText ? JSON.parse(responseText) : {};
            } catch (parseError) {
                console.log('Could not parse response as JSON, assuming success');
                return { success: true };
            }
        }

        // Event handlers para formularios
        elements.formPersonal.addEventListener('submit', async (e) => {
            e.preventDefault();
            loading = true;
            setLoading(elements.btnPersonal, true);
            hideMessage('error');
            hideMessage('success');

            try {
                // Obtener valores actuales del formulario
                const nombres = elements.inputNombres.value.trim();
                const apellidos = elements.inputApellidos.value.trim();
                const edad = elements.inputEdad.value.trim();

                // Validaciones básicas
                if (!nombres) {
                    throw new Error("El nombre es requerido");
                }
                if (!apellidos) {
                    throw new Error("Los apellidos son requeridos");
                }

                const updateData = { nombres, apellidos };

                // Solo agregar edad si se proporcionó
                if (edad) {
                    const edadNum = parseInt(edad);
                    if (isNaN(edadNum) || edadNum < 13 || edadNum > 120) {
                        throw new Error("La edad debe ser un número válido entre 13 y 120");
                    }
                    updateData.edad = edadNum;
                }

                console.log("Personal update data:", updateData);
                
                await makeRequest('/users/me', updateData);
                
                // Actualizar datos locales
                personalData.nombres = nombres;
                personalData.apellidos = apellidos;
                personalData.edad = edad;
                
                // Actualizar localStorage
                localStorage.setItem('userName', nombres);
                elements.topbarUsername.textContent = nombres;
                
                // Recargar datos para confirmar cambios
                await cargarDatosUsuario();
                
                showMessage('success', "Información personal actualizada correctamente");
            } catch (err) {
                console.error("Error updating personal data:", err);
                showMessage('error', "Error al actualizar la información personal: " + err.message);
            } finally {
                loading = false;
                setLoading(elements.btnPersonal, false);
            }
        });

        elements.formCuenta.addEventListener('submit', async (e) => {
            e.preventDefault();
            loading = true;
            setLoading(elements.btnCuenta, true);
            hideMessage('error');
            hideMessage('success');

            try {
                const email = elements.inputEmail.value.trim();
                
                if (!email) {
                    throw new Error("El correo electrónico es requerido");
                }

                // Validación básica de email
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    throw new Error("Por favor ingresa un correo electrónico válido");
                }

                const updateData = { 
                    correo: email.toLowerCase() 
                };
                
                console.log("Email update data:", updateData);
                
                await makeRequest('/users/me', updateData);
                
                // Actualizar datos locales
                cuentaData.email = email.toLowerCase();
                
                // Recargar datos para confirmar cambios
                await cargarDatosUsuario();
                
                showMessage('success', "Información de cuenta actualizada correctamente");
            } catch (err) {
                console.error("Error updating account data:", err);
                showMessage('error', "Error al actualizar la información de cuenta: " + err.message);
            } finally {
                loading = false;
                setLoading(elements.btnCuenta, false);
            }
        });

        elements.formManejo.addEventListener('submit', async (e) => {
            e.preventDefault();
            loading = true;
            setLoading(elements.btnManejo, true);
            hideMessage('error');
            hideMessage('success');

            try {
                const currentPassword = elements.inputCurrentPassword.value;
                const password = elements.inputPassword.value;
                const confirmPassword = elements.inputConfirmPassword.value;

                // Validaciones
                if (!currentPassword) {
                    throw new Error("Debes ingresar tu contraseña actual");
                }
                if (!password) {
                    throw new Error("Debes ingresar una nueva contraseña");
                }
                if (password !== confirmPassword) {
                    throw new Error("Las contraseñas no coinciden");
                }
                if (password.length < 8) {
                    throw new Error("La contraseña debe tener al menos 8 caracteres");
                }
                if (currentPassword === password) {
                    throw new Error("La nueva contraseña debe ser diferente a la actual");
                }

                // Preparar datos para cambio de contraseña
                const updateData = {
                    contrasenaActual: currentPassword,
                    nuevaContrasena: password,
                    confirmarNuevaContrasena: confirmPassword
                };

                console.log("Password change data:", { 
                    hasCurrentPassword: !!updateData.contrasenaActual,
                    hasNewPassword: !!updateData.nuevaContrasena,
                    hasConfirmation: !!updateData.confirmarNuevaContrasena,
                    endpoint: '/users/me'
                });

                await makeRequest('/users/me', updateData, true);
                
                showMessage('success', "Contraseña cambiada correctamente");
                
                // Limpiar formulario
                elements.inputCurrentPassword.value = "";
                elements.inputPassword.value = "";
                elements.inputConfirmPassword.value = "";
                
            } catch (err) {
                console.error("Error changing password:", err);
                showMessage('error', "Error al cambiar la contraseña: " + err.message);
            } finally {
                loading = false;
                setLoading(elements.btnManejo, false);
            }
        });

        // Event listeners para navegación
        elements.navPersonal.addEventListener('click', () => showSection('personal'));
        elements.navCuenta.addEventListener('click', () => showSection('cuenta'));
        elements.navManejo.addEventListener('click', () => showSection('manejo'));
        
        elements.navLogout.addEventListener('click', () => {
            localStorage.clear();
            window.location.href = 'login.html';
        });

        elements.btnDeleteAccount.addEventListener('click', () => {
            window.location.href = 'eliminar-cuenta.html';
        });

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar datos del usuario
            const storedUserName = localStorage.getItem('userName');
            if (storedUserName) {
                elements.topbarUsername.textContent = storedUserName;
            }

            // Cargar datos desde la API
            cargarDatosUsuario();
        });
    </script>
</body>
</html>