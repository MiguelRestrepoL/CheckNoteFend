<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperar Contraseña - CheckNote</title>
    <link rel="stylesheet" href="./GlobalCSS1.css">
    <style>
        /* Estilos específicos para olvidar contraseña */
        .success-message {
            text-align: center;
            padding: 20px;
        }
        
        .success-message h2 {
            color: var(--text-primary);
            margin-bottom: var(--spacing-lg);
        }
        
        .success-message .success-text {
            color: #c2dbc8ff;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .success-message .info-text {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .btn-secondary {
            background: var(--card-bg-2);
            color: var(--text-primary);
            border: 1px solid var(--text-secondary);
            margin-top: 10px;
        }
        
        .btn-secondary:hover {
            background: var(--field-bg);
            opacity: 0.9;
        }
        
        .debug-info {
            background: #2d3748;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 12px;
            color: #a0aec0;
            font-family: monospace;
        }
        
        .debug-info strong {
            color: #ffffff;
        }
        
        .hidden {
            display: none;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Loading animation */
        .btn.loading {
            position: relative;
            color: transparent;
        }
        
        .btn.loading::after {
            content: "";
            position: absolute;
            width: 18px;
            height: 18px;
            top: 50%;
            left: 50%;
            margin-left: -9px;
            margin-top: -9px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Vista principal del formulario -->
        <div id="form-view" class="main-container gradient-bg">
            <div class="card forgot-style with-shadow">
                <div class="logo size-md">
                    <img src="/logo.png" alt="Checknote" />
                    <h1>Checknote</h1>
                </div>

                <h2 class="title-secondary">Ingrese el correo con el que creó la cuenta</h2>

                <!-- Info de debugging (solo en desarrollo) -->
                <div id="debug-info" class="debug-info hidden">
                    <strong>DEBUG INFO:</strong><br />
                    <span id="debug-email">Email: </span><br />
                    URL: /api/v1/auth/request-password-reset<br />
                    <span id="debug-payload">Payload: </span>
                </div>

                <form class="form compact" id="forgot-password-form">
                    <div class="field-group">
                        <img src="/correo.png" alt="Email" class="field-icon" />
                        <div class="field-input">
                            <label>Email</label>
                            <input
                                type="email"
                                id="email-input"
                                placeholder="ejemplo@correo.com"
                                required
                            />
                        </div>
                    </div>

                    <!-- Mensaje de error -->
                    <div id="error-message" class="text-error hidden"></div>

                    <button type="submit" class="btn btn-primary" id="submit-btn">
                        <span id="btn-text">Enviar enlace de recuperación</span>
                    </button>
                </form>

                <div class="links-section">
                    ¿No tiene cuenta? <a href="registro.html" class="link">Registrarse</a>
                </div>
            </div>
        </div>

        <!-- Vista de éxito -->
        <div id="success-view" class="main-container gradient-bg hidden">
            <div class="card forgot-style with-shadow">
                <div class="logo size-md">
                    <img src="/logo.png" alt="Checknote" />
                    <h1>Checknote</h1>
                </div>

                <div class="success-message">
                    <h2 class="title-secondary">¡Correo enviado!</h2>
                    <p class="success-text">
                        Hemos enviado un enlace de recuperación a <strong><span id="sent-email"></span></strong>
                    </p>
                    <p class="info-text">
                        Revisa tu bandeja de entrada y haz clic en el enlace para restablecer tu contraseña.
                        Si no ves el correo, revisa tu carpeta de spam.
                    </p>
                    
                    <button id="send-another-btn" class="btn btn-secondary">
                        Enviar otro correo
                    </button>
                </div>

                <div class="links-section">
                    <a href="login.html" class="link">Volver al inicio de sesión</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentEmail = '';
        let isLoading = false;
        const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

        // Referencias DOM
        const formView = document.getElementById('form-view');
        const successView = document.getElementById('success-view');
        const form = document.getElementById('forgot-password-form');
        const emailInput = document.getElementById('email-input');
        const submitBtn = document.getElementById('submit-btn');
        const btnText = document.getElementById('btn-text');
        const errorMessage = document.getElementById('error-message');
        const debugInfo = document.getElementById('debug-info');
        const debugEmail = document.getElementById('debug-email');
        const debugPayload = document.getElementById('debug-payload');
        const sentEmail = document.getElementById('sent-email');
        const sendAnotherBtn = document.getElementById('send-another-btn');

        // Funciones utilitarias
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }

        function setLoading(loading) {
            isLoading = loading;
            
            if (loading) {
                submitBtn.classList.add('loading');
                submitBtn.disabled = true;
                btnText.textContent = 'Enviando...';
            } else {
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
                btnText.textContent = 'Enviar enlace de recuperación';
            }
        }

        function updateDebugInfo() {
            if (isDevelopment) {
                debugInfo.classList.remove('hidden');
                const email = emailInput.value;
                const payload = { correo: email.trim().toLowerCase() };
                
                debugEmail.textContent = `Email: ${email}`;
                debugPayload.textContent = `Payload: ${JSON.stringify(payload)}`;
            }
        }

        function showSuccessView(email) {
            formView.classList.add('hidden');
            successView.classList.remove('hidden');
            sentEmail.textContent = email;
        }

        function showFormView() {
            successView.classList.add('hidden');
            formView.classList.remove('hidden');
            emailInput.value = '';
            currentEmail = '';
            hideError();
        }

        // Validar email en tiempo real
        emailInput.addEventListener('input', function() {
            const email = this.value.trim();
            
            // Habilitar/deshabilitar botón
            submitBtn.disabled = !email || isLoading;
            
            // Actualizar debug info
            updateDebugInfo();
            
            // Limpiar error si hay texto
            if (email) {
                hideError();
            }
        });

        // Manejar envío del formulario
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (isLoading) return;
            
            const email = emailInput.value.trim();
            
            if (!email) {
                showError('Por favor ingrese su correo electrónico');
                return;
            }

            console.log("=== DEBUGGING FORGOT PASSWORD ===");
            console.log("1. Email ingresado:", email);
            console.log("2. Email procesado:", email.toLowerCase());

            setLoading(true);
            hideError();
            currentEmail = email;

            try {
                const payload = { correo: email.toLowerCase() };
                console.log("4. Payload a enviar:", JSON.stringify(payload, null, 2));

                const response = await fetch("https://checknote-27fe.onrender.com/api/v1/auth/request-password-reset", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify(payload),
                });

                console.log("5. Status de respuesta:", response.status);

                let data;
                try {
                    const responseText = await response.text();
                    console.log("8. Respuesta raw:", responseText);
                    
                    if (responseText) {
                        data = JSON.parse(responseText);
                        console.log("9. Respuesta parseada:", data);
                    } else {
                        data = {};
                    }
                } catch (parseError) {
                    console.error("9. Error parseando respuesta:", parseError);
                    throw new Error("Respuesta del servidor no es válida");
                }

                if (response.ok) {
                    console.log("10. ✅ Éxito - Mostrando mensaje de confirmación");
                    showSuccessView(email);
                } else {
                    console.log("10. ❌ Error del servidor");
                    
                    let errorMsg;
                    if (response.status === 400) {
                        errorMsg = data.message || "Error en los datos enviados";
                    } else if (response.status === 404) {
                        errorMsg = "Correo no encontrado en el sistema";
                    } else if (response.status === 429) {
                        errorMsg = "Demasiadas solicitudes. Espera un momento e intenta nuevamente.";
                    } else if (response.status === 500) {
                        errorMsg = "Error interno del servidor. Intenta más tarde.";
                    } else {
                        errorMsg = data.message || `Error ${response.status}: ${response.statusText}`;
                    }
                    
                    showError(errorMsg);
                }

            } catch (error) {
                console.error("11. ❌ Error en la petición:", error);
                
                let errorMsg;
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMsg = "Error de conexión. Verifica tu internet y que el servidor esté funcionando.";
                } else if (error.message.includes('JSON')) {
                    errorMsg = "Error procesando respuesta del servidor.";
                } else {
                    errorMsg = "Error de conexión con el servidor: " + error.message;
                }
                
                showError(errorMsg);
            } finally {
                setLoading(false);
            }
        });

        // Botón "Enviar otro correo"
        sendAnotherBtn.addEventListener('click', function() {
            showFormView();
        });

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            // Mostrar debug info si es desarrollo
            if (isDevelopment) {
                updateDebugInfo();
            }
            
            // Focus en el input
            emailInput.focus();
            
            // Deshabilitar botón inicialmente
            submitBtn.disabled = true;
        });
    </script>
</body>
</html>