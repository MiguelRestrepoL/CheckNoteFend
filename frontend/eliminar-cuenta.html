<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eliminar Cuenta - CheckNote</title>
    <link rel="stylesheet" href="./GlobalCSS3.css">
    <style>
        /* OVERRIDE DE ESTILOS DE GLOBALCSS3 PARA ESTA P√ÅGINA */
        /* Redefinir anchos m√°s apropiados para eliminar cuenta */
        .form-field.field-sm,
        .form-field.field-md,
        .form-field.field-lg {
            max-width: 540px !important;
            width: 100% !important;
        }

        .form-field .form-label,
        .form-field .form-input {
            width: 100% !important;
            max-width: none !important;
        }

        /* Estilos espec√≠ficos para eliminar cuenta */
        .danger-steps {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: var(--radius-sm);
            padding: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
        }

        .danger-steps h3 {
            color: #ef4444;
            margin-bottom: var(--spacing-md);
            font-size: 16px;
        }

        .danger-steps ol {
            color: var(--text-muted);
            font-size: 14px;
            line-height: 1.6;
            padding-left: var(--spacing-xl);
        }

        .danger-steps li {
            margin-bottom: var(--spacing-sm);
        }

        .confirmation-input {
            background: rgba(239, 68, 68, 0.1) !important;
            border: 2px solid rgba(239, 68, 68, 0.3) !important;
            color: var(--text-primary);
            margin: var(--spacing-lg) 0;
        }

        .confirmation-input:focus {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
        }

        .confirmation-text {
            font-family: monospace;
            background: rgba(255,255,255,0.1);
            padding: var(--spacing-sm);
            border-radius: 4px;
            display: inline-block;
            margin: var(--spacing-sm) 0;
            font-weight: bold;
        }

        /* Ajustar el contenedor principal para campos m√°s estrechos */
        .task-card {
            max-width: 600px !important;
        }

        /* Botones m√°s apropiados */
        .button-group .action-button {
            max-width: 400px !important;
        }

        @media (max-width: 768px) {
            .form-container {
                margin: var(--spacing-md);
                padding: var(--spacing-lg);
            }

            .button-group {
                flex-direction: column;
            }

            .form-field.field-sm,
            .form-field.field-md,
            .form-field.field-lg {
                max-width: none !important;
            }

            .btn-danger, .btn-secondary {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="page-root">
        <!-- TOPBAR -->
        <header class="topbar">
            <div class="topbar-left">
                <a href="perfil.html" style="display: flex; align-items: center; text-decoration: none;">
                    <img src="/back.png" alt="volver" class="icon" style="margin-right: 8px;" />
                    <span style="color: var(--text-primary);">Volver</span>
                </a>
            </div>

            <div class="topbar-center">
                <span style="color: var(--text-primary); font-weight: 500;">Eliminar Cuenta</span>
            </div>

            <div class="topbar-right">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <img src="/usuario.png" alt="usuario" class="icon user-icon" />
                    <span class="username" id="username">Usuario</span>
                </div>
            </div>
        </header>

        <!-- MAIN -->
        <main class="main">
            <div class="center-column">
                <!-- Mensajes de estado -->
                <div id="error-message" class="status-message error hidden"></div>
                <div id="success-message" class="status-message success hidden"></div>

                <!-- Estado de carga -->
                <div id="loading-state" class="loading-container">
                    <h3>Cargando informaci√≥n de la cuenta...</h3>
                    <div class="loading-icon">‚è≥</div>
                </div>

                <!-- Contenedor principal -->
                <div id="delete-container" class="task-card hidden">
                    <div class="section-header">
                        <h1 class="task-title" style="color: #ef4444;">üóëÔ∏è Eliminar Cuenta</h1>
                        <p class="section-description">Esta acci√≥n es permanente e irreversible</p>
                    </div>

                    <!-- Advertencia Principal -->
                    <div class="status-message error" style="text-align: left;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <span style="font-size: 24px;">‚ö†Ô∏è</span>
                            <strong>¬°ADVERTENCIA CR√çTICA!</strong>
                        </div>
                        <p>Est√°s a punto de eliminar permanentemente tu cuenta de CheckNote. Esta acci√≥n:</p>
                        <ul style="margin: 12px 0; padding-left: 20px;">
                            <li>Eliminar√° todos tus datos personales</li>
                            <li>Borrar√° todas tus tareas y proyectos</li>
                            <li>No se puede deshacer bajo ninguna circunstancia</li>
                            <li>Requerir√° crear una nueva cuenta si deseas volver</li>
                        </ul>
                    </div>

                    <!-- Informaci√≥n del Usuario -->
                    <div class="danger-steps">
                        <h3>Datos de la cuenta a eliminar:</h3>
                        <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px; margin-top: 12px;">
                            <div style="margin-bottom: 8px;">
                                <strong>Nombre:</strong> <span id="user-nombre">Cargando...</span>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Email:</strong> <span id="user-email">Cargando...</span>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Cuenta creada:</strong> <span id="user-fecha">Cargando...</span>
                            </div>
                            <div>
                                <strong>Tareas registradas:</strong> <span id="user-tareas">Calculando...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Pasos para confirmar -->
                    <div class="danger-steps">
                        <h3>Para proceder, debes completar los siguientes pasos:</h3>
                        <ol>
                            <li>Ingresa tu contrase√±a actual para verificar tu identidad</li>
                            <li>Escribe exactamente la frase de confirmaci√≥n que aparece abajo</li>
                            <li>Confirma que entiendes que esta acci√≥n es irreversible</li>
                        </ol>
                    </div>

                    <!-- Formulario de confirmaci√≥n -->
                    <form id="delete-form" class="form-container">
                        <!-- Contrase√±a -->
                        <div class="form-field field-md">
                            <div class="form-label">CONTRASE√ëA ACTUAL üîí</div>
                            <input
                                type="password"
                                id="password-input"
                                name="password"
                                placeholder="Ingresa tu contrase√±a actual"
                                class="form-input"
                                required
                            />
                        </div>

                        <!-- Frase de confirmaci√≥n -->
                        <div class="form-field field-md">
                            <div class="form-label">CONFIRMACI√ìN ‚ö†Ô∏è</div>
                            <p style="margin-bottom: 8px; font-size: 14px; color: var(--text-muted);">
                                Escribe exactamente esta frase:
                            </p>
                            <div class="confirmation-text">ELIMINAR</div>
                            <input
                                type="text"
                                id="confirmation-input"
                                name="confirmation"
                                placeholder="Escribe la frase exacta aqu√≠"
                                class="form-input confirmation-input"
                                required
                            />
                        </div>

                        <!-- Checkbox final -->
                        <div style="margin: var(--spacing-lg) 0; display: flex; align-items: flex-start; gap: 12px;">
                            <input
                                type="checkbox"
                                id="final-confirmation"
                                required
                                style="margin-top: 4px; width: 18px; height: 18px;"
                            />
                            <label for="final-confirmation" style="font-size: 14px; color: var(--text-muted); line-height: 1.5;">
                                Confirmo que he le√≠do y entendido todas las advertencias. Acepto que esta acci√≥n eliminar√° permanentemente mi cuenta y todos mis datos, y que no podr√° ser revertida bajo ninguna circunstancia.
                            </label>
                        </div>

                        <!-- Botones -->
                        <div class="button-group" style="display: flex; gap: 16px; margin-top: var(--spacing-xl);">
                            <button type="submit" id="delete-btn" class="action-button danger" disabled>
                                üóëÔ∏è ELIMINAR CUENTA PERMANENTEMENTE
                            </button>
                            <a href="perfil.html" class="action-button" style="background: #6b7280; text-decoration: none; display: flex; align-items: center; justify-content: center;">
                                ‚ùå Cancelar y Volver
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </main>

        <!-- FOOTER -->
        <footer class="footer">
            <a href="home.html" class="footer-link">
                <img src="/home.png" alt="inicio" class="icon" />
                <span class="footer-text">Inicio</span>
            </a>
        </footer>
    </div>

    <script>
        // Variables globales
        let usuarioActual = null;

        // Referencias DOM
        const elements = {
            loadingState: document.getElementById('loading-state'),
            deleteContainer: document.getElementById('delete-container'),
            errorMessage: document.getElementById('error-message'),
            successMessage: document.getElementById('success-message'),
            userNombre: document.getElementById('user-nombre'),
            userEmail: document.getElementById('user-email'),
            userFecha: document.getElementById('user-fecha'),
            userTareas: document.getElementById('user-tareas'),
            passwordInput: document.getElementById('password-input'),
            confirmationInput: document.getElementById('confirmation-input'),
            finalConfirmation: document.getElementById('final-confirmation'),
            deleteBtn: document.getElementById('delete-btn'),
            deleteForm: document.getElementById('delete-form'),
            username: document.getElementById('username')
        };

        // Funci√≥n para mostrar mensajes
        function showMessage(type, message, duration = 0) {
            const messageEl = elements[type + 'Message'];
            if (messageEl) {
                messageEl.textContent = message;
                messageEl.classList.remove('hidden');
                
                if (duration > 0) {
                    setTimeout(() => messageEl.classList.add('hidden'), duration);
                }
            }
        }

        function hideMessage(type) {
            const messageEl = elements[type + 'Message'];
            if (messageEl) {
                messageEl.classList.add('hidden');
            }
        }

        // Funci√≥n para cargar datos del usuario
        async function cargarDatosUsuario() {
            const token = localStorage.getItem('token');
            if (!token) {
                showMessage('error', 'No hay sesi√≥n activa. Redirigiendo al login...');
                setTimeout(() => window.location.href = 'login.html', 2000);
                return;
            }

            try {
                // Cargar datos del usuario desde la API
                const response = await fetch("https://checknote-27fe.onrender.com/api/v1/users/me", {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json",
                    },
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.clear();
                        showMessage('error', "Tu sesi√≥n ha expirado. Redirigiendo al login...");
                        setTimeout(() => window.location.href = 'login.html', 2000);
                        return;
                    }
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const responseData = await response.json();
                usuarioActual = responseData.data?.usuario || responseData.user || responseData.usuario || responseData;
                
                if (!usuarioActual.nombres && responseData.data) {
                    usuarioActual = responseData.data;
                }

                // Mostrar datos del usuario
                elements.userNombre.textContent = `${usuarioActual.nombres || ''} ${usuarioActual.apellidos || ''}`.trim() || 'Sin nombre';
                elements.userEmail.textContent = usuarioActual.correo || usuarioActual.email || 'Sin email';
                
                const fechaCreacion = usuarioActual.createdAt || usuarioActual.fechaRegistro;
                if (fechaCreacion) {
                    elements.userFecha.textContent = new Date(fechaCreacion).toLocaleDateString('es-ES');
                } else {
                    elements.userFecha.textContent = 'Fecha no disponible';
                }

                // Actualizar username en topbar
                elements.username.textContent = usuarioActual.nombres || 'Usuario';

                // Cargar n√∫mero de tareas (opcional - puede fallar sin afectar el proceso)
                await cargarNumeroTareas(token);

            } catch (error) {
                console.error('Error cargando datos del usuario:', error);
                showMessage('error', 'Error al cargar los datos del usuario: ' + error.message);
                
                // Intentar cargar datos desde localStorage como fallback
                const storedUser = localStorage.getItem('user');
                if (storedUser) {
                    try {
                        usuarioActual = JSON.parse(storedUser);
                        elements.userNombre.textContent = `${usuarioActual.nombres || ''} ${usuarioActual.apellidos || ''}`.trim() || 'Sin nombre';
                        elements.userEmail.textContent = usuarioActual.correo || usuarioActual.email || 'Sin email';
                        elements.userFecha.textContent = usuarioActual.createdAt ? 
                            new Date(usuarioActual.createdAt).toLocaleDateString('es-ES') : 'Fecha no disponible';
                        elements.username.textContent = usuarioActual.nombres || 'Usuario';
                    } catch (parseError) {
                        console.error('Error parsing stored user data:', parseError);
                    }
                }
            } finally {
                // Mostrar el contenedor y ocultar loading
                elements.loadingState.classList.add('hidden');
                elements.deleteContainer.classList.remove('hidden');
            }
        }

        // Funci√≥n para cargar n√∫mero de tareas
        async function cargarNumeroTareas(token) {
            try {
                const response = await fetch("https://checknote-27fe.onrender.com/api/v1/tasks", {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json",
                    },
                });

                if (response.ok) {
                    const tasksData = await response.json();
                    const tasks = tasksData.data?.tasks || tasksData.tasks || tasksData || [];
                    elements.userTareas.textContent = tasks.length + ' tarea(s)';
                } else {
                    elements.userTareas.textContent = 'No disponible';
                }
            } catch (error) {
                console.error('Error cargando n√∫mero de tareas:', error);
                elements.userTareas.textContent = 'No disponible';
            }
        }

        // Funci√≥n para validar el formulario
        function validarFormulario() {
            const password = elements.passwordInput.value.trim();
            const confirmation = elements.confirmationInput.value.trim();
            const isChecked = elements.finalConfirmation.checked;

            const isValid = password && 
                           confirmation === 'ELIMINAR' && 
                           isChecked;

            elements.deleteBtn.disabled = !isValid;
            
            if (isValid) {
                elements.deleteBtn.style.opacity = '1';
            } else {
                elements.deleteBtn.style.opacity = '0.5';
            }
        }

        // Funci√≥n para eliminar la cuenta
        async function eliminarCuenta(event) {
            event.preventDefault();

            const password = elements.passwordInput.value.trim();
            const confirmation = elements.confirmationInput.value.trim();
            const isChecked = elements.finalConfirmation.checked;

            // Validaciones finales
            if (!password) {
                showMessage('error', 'Debes ingresar tu contrase√±a actual');
                return;
            }

            if (confirmation !== 'ELIMINAR') {
                showMessage('error', 'La frase de confirmaci√≥n no coincide exactamente');
                return;
            }

            if (!isChecked) {
                showMessage('error', 'Debes confirmar que entiendes las consecuencias');
                return;
            }

            const token = localStorage.getItem('token');
            if (!token) {
                showMessage('error', 'No hay sesi√≥n activa');
                return;
            }

            try {
                // Deshabilitar bot√≥n y mostrar estado de carga
                elements.deleteBtn.disabled = true;
                elements.deleteBtn.textContent = 'üóëÔ∏è ELIMINANDO CUENTA...';
                hideMessage('error');

                // Hacer request DELETE al endpoint de usuario
                const response = await fetch('https://checknote-27fe.onrender.com/api/v1/users/me', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contrasenaActual: password,
                        confirmacion: "ELIMINAR"
                    }),
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        const errorText = await response.text();
                        try {
                            const errorData = JSON.parse(errorText);
                            if (errorData.message && errorData.message.toLowerCase().includes("contrase√±a")) {
                                throw new Error("La contrase√±a ingresada es incorrecta");
                            }
                        } catch (parseError) {
                            // Si no se puede parsear, usar mensaje gen√©rico
                        }
                        throw new Error("La contrase√±a ingresada es incorrecta");
                    }
                    
                    const errorText = await response.text();
                    let errorMessage = `Error ${response.status}`;
                    
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.message || errorData.error || errorMessage;
                    } catch (parseError) {
                        errorMessage = errorText || errorMessage;
                    }
                    
                    throw new Error(errorMessage);
                }

                // Cuenta eliminada exitosamente
                showMessage('success', '‚úÖ Tu cuenta ha sido eliminada exitosamente');
                
                // Limpiar todo el localStorage
                localStorage.clear();
                sessionStorage.clear();

                // Mostrar mensaje final y redirigir
                setTimeout(() => {
                    showMessage('success', 'Redirigiendo... Gracias por haber usado CheckNote.');
                }, 2000);

                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 4000);

            } catch (error) {
                console.error('Error eliminando cuenta:', error);
                showMessage('error', 'Error al eliminar la cuenta: ' + error.message);
            } finally {
                // Rehabilitar bot√≥n (solo si no fue exitoso)
                if (elements.deleteBtn.textContent.includes('ELIMINANDO')) {
                    elements.deleteBtn.disabled = false;
                    elements.deleteBtn.textContent = 'üóëÔ∏è ELIMINAR CUENTA PERMANENTEMENTE';
                }
            }
        }

        // Event listeners
        elements.passwordInput.addEventListener('input', validarFormulario);
        elements.confirmationInput.addEventListener('input', validarFormulario);
        elements.finalConfirmation.addEventListener('change', validarFormulario);
        elements.deleteForm.addEventListener('submit', eliminarCuenta);

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticaci√≥n
            const token = localStorage.getItem('token');
            if (!token) {
                showMessage('error', 'No hay sesi√≥n activa. Redirigiendo al login...');
                setTimeout(() => window.location.href = 'login.html', 2000);
                return;
            }

            // Cargar datos del usuario
            setTimeout(cargarDatosUsuario, 500);
        });
    </script>
</body>
</html>