
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Contrase√±a - CheckNote</title>
    <link rel="stylesheet" href="global.css">
</head>
<body>
    <!-- Loading Page -->
    <div id="loading-page" class="page active">
        <div class="main-container gradient-bg">
            <div class="card forgot-style with-shadow">
                <div class="logo size-md">
                    <img src="/logo.png" alt="Checknote" />
                    <h1>Checknote</h1>
                </div>
                
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="
                        width: 60px;
                        height: 60px;
                        border: 4px solid #f3f3f3;
                        border-top: 4px solid #28a745;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin: 0 auto 20px auto;
                    "></div>
                    <h2 class="title-secondary">Validando enlace...</h2>
                    <p style="color: #6c757d;">Verificando que su enlace sea v√°lido</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Page -->
    <div id="error-page" class="page">
        <div class="main-container gradient-bg">
            <div class="card forgot-style with-shadow">
                <div class="logo size-md">
                    <img src="/logo.png" alt="Checknote" />
                    <h1>Checknote</h1>
                </div>
                
                <div style="text-align: center; padding: 20px;">
                    <h2 class="title-secondary" style="color: #dc3545;">‚ùå Acceso denegado</h2>
                    <p id="error-message" style="color: #6c757d; margin-bottom: 20px;">
                        Debe acceder desde el enlace enviado a su correo electr√≥nico
                    </p>
                    <a href="/olvidar-password" class="btn btn-primary btn-rounded">
                        Solicitar nuevo enlace
                    </a>
                </div>

                <div class="links-section">
                    <a href="/login" class="link">‚Üê Volver al login</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Form Page -->
    <div id="main-page" class="page">
        <div class="main-container gradient-bg">
            <div class="card forgot-style with-shadow">
                <!-- Logo -->
                <div class="logo size-md">
                    <img src="/logo.png" alt="Checknote" />
                    <h1>Checknote</h1>
                </div>

                <!-- T√≠tulo -->
                <h2 class="title-secondary">üîê Nueva Contrase√±a</h2>
                <p class="subtitle">Cree una contrase√±a segura para su cuenta</p>

                <!-- Formulario -->
                <form id="reset-form" class="form compact">
                    <!-- Nueva Contrase√±a -->
                    <div class="field-group">
                        <img src="/pw.png" alt="Contrase√±a" class="field-icon" />
                        <div class="field-input">
                            <label>Nueva Contrase√±a *</label>
                            <input
                                type="password"
                                id="password"
                                placeholder="Ingrese su nueva contrase√±a"
                                required
                                minlength="8"
                                maxlength="128"
                            />
                        </div>
                    </div>

                    <!-- Indicador de fortaleza -->
                    <div id="password-strength" style="display: none; margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 13px; font-weight: 600;">
                                Fortaleza: <span id="strength-text" style="color: #6c757d;">Sin evaluar</span>
                            </span>
                            <div style="width: 100px; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                                <div id="strength-bar" style="width: 0%; height: 100%; background: #6c757d; transition: width 0.3s ease; border-radius: 4px;"></div>
                            </div>
                        </div>
                        <div id="strength-missing" style="font-size: 12px; color: #6c757d; display: none;">
                            <strong>Falta:</strong> <span id="missing-requirements"></span>
                        </div>
                    </div>

                    <!-- Confirmar Contrase√±a -->
                    <div class="field-group">
                        <img src="/pw.png" alt="Confirmar" class="field-icon" />
                        <div class="field-input">
                            <label>Confirmar Contrase√±a *</label>
                            <input
                                type="password"
                                id="confirm-password"
                                placeholder="Confirme su nueva contrase√±a"
                                required
                            />
                            <div id="password-match" style="font-size: 12px; margin-top: 5px; display: none;"></div>
                        </div>
                    </div>

                    <!-- Mensaje de √©xito -->
                    <div id="success-message" style="
                        display: none;
                        padding: 12px; 
                        background: #d4edda; 
                        color: #155724; 
                        border: 1px solid #c3e6cb;
                        border-radius: 8px; 
                        margin-bottom: 15px;
                        text-align: center;
                        font-weight: 500;
                    "></div>

                    <!-- Error -->
                    <div id="form-error" style="
                        display: none;
                        padding: 12px; 
                        background: #f8d7da; 
                        color: #721c24; 
                        border: 1px solid #f5c6cb;
                        border-radius: 8px; 
                        margin-bottom: 15px;
                        text-align: center;
                        font-weight: 500;
                    "></div>

                    <!-- Bot√≥n -->
                    <button 
                        type="submit" 
                        id="submit-btn"
                        class="btn btn-primary btn-rounded" 
                        disabled
                    >
                        üîê Establecer Nueva Contrase√±a
                    </button>
                </form>

                <!-- Enlaces -->
                <div class="links-section">
                    <a href="/olvidar-password" class="link">Solicitar nuevo enlace</a>
                    <span style="margin: 0 8px; color: #dee2e6;">|</span>
                    <a href="/login" class="link">‚Üê Volver al login</a>
                </div>

                <!-- Informaci√≥n de debugging -->
                <div id="debug-info" style="
                    display: none;
                    margin-top: 20px;
                    background: #2d3748; 
                    padding: 12px; 
                    border-radius: 8px; 
                    font-size: 11px;
                    color: #a0aec0;
                    font-family: monospace;
                ">
                    <strong>üîß DEBUG INFO:</strong><br />
                    <span id="debug-token">Token: No disponible</span><br />
                    <span id="debug-validated">Validado: ‚ùå</span><br />
                    Endpoint: POST /api/v1/auth/reset-password
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado global
        let appState = {
            resetToken: '',
            tokenValidated: false,
            loading: false
        };

        // Referencias DOM
        const loadingPage = document.getElementById('loading-page');
        const errorPage = document.getElementById('error-page');
        const mainPage = document.getElementById('main-page');
        const errorMessage = document.getElementById('error-message');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const submitBtn = document.getElementById('submit-btn');
        const resetForm = document.getElementById('reset-form');

        // Elementos de fortaleza
        const strengthIndicator = document.getElementById('password-strength');
        const strengthText = document.getElementById('strength-text');
        const strengthBar = document.getElementById('strength-bar');
        const strengthMissing = document.getElementById('strength-missing');
        const missingRequirements = document.getElementById('missing-requirements');
        
        // Elementos de mensajes
        const passwordMatch = document.getElementById('password-match');
        const successMessage = document.getElementById('success-message');
        const formError = document.getElementById('form-error');
        
        // Elementos de debug
        const debugInfo = document.getElementById('debug-info');
        const debugToken = document.getElementById('debug-token');
        const debugValidated = document.getElementById('debug-validated');

        // Funci√≥n para obtener par√°metros de URL
        function getURLParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // Funci√≥n para obtener token de la URL
        function getTokenFromURL() {
            // Intentar desde path segments
            const pathParts = window.location.pathname.split('/');
            const possibleToken = pathParts[pathParts.length - 1];
            
            // Intentar desde query parameter
            const tokenFromQuery = getURLParam('token');
            
            // Si hay token en query, usarlo; sino usar el del path si parece v√°lido
            return tokenFromQuery || (possibleToken && possibleToken.length >= 32 ? possibleToken : null);
        }

        // Funci√≥n de validaci√≥n de contrase√±a
        function validatePassword(password) {
            const errors = [];

            if (!password) {
                return { valid: false, errors: ['La contrase√±a es requerida'] };
            }

            if (password.length < 8) {
                errors.push('La contrase√±a debe tener al menos 8 caracteres');
            }

            if (password.length > 128) {
                errors.push('La contrase√±a no puede exceder 128 caracteres');
            }

            if (!/[a-z]/.test(password)) {
                errors.push('Debe contener al menos una letra min√∫scula');
            }

            if (!/[A-Z]/.test(password)) {
                errors.push('Debe contener al menos una letra may√∫scula');
            }

            if (!/\d/.test(password)) {
                errors.push('Debe contener al menos un n√∫mero');
            }

            if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
                errors.push('Debe contener al menos un car√°cter especial (!@#$%^&*...)');
            }

            return {
                valid: errors.length === 0,
                errors
            };
        }

        // Funci√≥n para evaluar fortaleza de contrase√±a
        function getPasswordStrength(password) {
            if (!password) return { 
                strength: 0, 
                text: 'Sin evaluar', 
                color: '#6c757d', 
                missing: [] 
            };
            
            let strength = 0;
            let missing = [];

            if (password.length >= 8) strength += 1;
            else missing.push('8+ caracteres');

            if (/[a-z]/.test(password)) strength += 1;
            else missing.push('min√∫sculas');

            if (/[A-Z]/.test(password)) strength += 1;
            else missing.push('may√∫sculas');

            if (/\d/.test(password)) strength += 1;
            else missing.push('n√∫meros');

            if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) strength += 1;
            else missing.push('s√≠mbolos');

            const colors = ['#dc3545', '#fd7e14', '#ffc107', '#28a745', '#006600'];
            const texts = ['Muy d√©bil', 'D√©bil', 'Regular', 'Fuerte', 'Muy fuerte'];

            return {
                strength,
                text: texts[strength] || 'Sin evaluar',
                color: colors[strength] || '#6c757d',
                missing
            };
        }

        // Funci√≥n para mostrar p√°gina espec√≠fica
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        // Funci√≥n para actualizar indicador de fortaleza
        function updatePasswordStrength() {
            const password = passwordInput.value;
            const strength = getPasswordStrength(password);
            
            if (password) {
                strengthIndicator.style.display = 'block';
                strengthText.textContent = strength.text;
                strengthText.style.color = strength.color;
                strengthBar.style.width = `${(strength.strength / 5) * 100}%`;
                strengthBar.style.background = strength.color;
                
                if (strength.missing.length > 0) {
                    strengthMissing.style.display = 'block';
                    missingRequirements.textContent = strength.missing.join(', ');
                } else {
                    strengthMissing.style.display = 'none';
                }
            } else {
                strengthIndicator.style.display = 'none';
            }
        }

        // Funci√≥n para actualizar coincidencia de contrase√±as
        function updatePasswordMatch() {
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            
            if (confirmPassword) {
                passwordMatch.style.display = 'block';
                if (password === confirmPassword) {
                    passwordMatch.innerHTML = '<span style="color: #28a745;">‚úì Las contrase√±as coinciden</span>';
                } else {
                    passwordMatch.innerHTML = '<span style="color: #dc3545;">‚úó Las contrase√±as no coinciden</span>';
                }
            } else {
                passwordMatch.style.display = 'none';
            }
        }

        // Funci√≥n para validar formulario completo
        function validateForm() {
            const password = passwordInput.value.trim();
            const confirmPassword = confirmPasswordInput.value.trim();
            const passwordValidation = validatePassword(password);
            
            const isValid = password && 
                           confirmPassword && 
                           password === confirmPassword && 
                           passwordValidation.valid && 
                           !appState.loading;
            
            submitBtn.disabled = !isValid;
            submitBtn.style.opacity = isValid ? '1' : '0.6';
        }

        // Funci√≥n para mostrar mensajes
        function showMessage(element, message, show = true) {
            if (show && message) {
                element.textContent = message;
                element.style.display = 'block';
            } else {
                element.style.display = 'none';
            }
        }

        // Inicializaci√≥n al cargar la p√°gina
        window.addEventListener('DOMContentLoaded', function() {
            console.log('=== INICIANDO VALIDACI√ìN DE TOKEN ===');
            
            // Obtener token
            const token = getTokenFromURL();
            
            console.log('Token desde URL:', token);
            console.log('Path completo:', window.location.pathname);
            console.log('Query params:', window.location.search);

            if (!token) {
                console.log('‚ùå Token no encontrado');
                errorMessage.textContent = 'Token no encontrado. Debe acceder desde el enlace del email.';
                showPage('error-page');
                return;
            }

            if (token.length < 32) {
                console.log('‚ùå Formato de token inv√°lido');
                errorMessage.textContent = 'Formato de token inv√°lido. Debe acceder desde el enlace del email.';
                showPage('error-page');
                return;
            }

            console.log('‚úÖ Token disponible, listo para usar');
            appState.resetToken = token;
            appState.tokenValidated = true;
            
            // Mostrar informaci√≥n de debug en desarrollo
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                debugInfo.style.display = 'block';
                debugToken.textContent = `Token: ${token.substring(0, 20)}... (${token.length} chars)`;
                debugValidated.textContent = 'Validado: ‚úÖ';
            }
            
            // Simular loading y mostrar formulario
            setTimeout(() => {
                showPage('main-page');
            }, 1500);
        });

        // Event listeners para validaci√≥n en tiempo real
        passwordInput.addEventListener('input', function() {
            updatePasswordStrength();
            updatePasswordMatch();
            validateForm();
        });

        confirmPasswordInput.addEventListener('input', function() {
            updatePasswordMatch();
            validateForm();
        });

        // Manejar env√≠o del formulario
        resetForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!appState.resetToken || !appState.tokenValidated) {
                showMessage(formError, 'Token no v√°lido. Debe acceder desde el enlace del email.');
                return;
            }

            const password = passwordInput.value.trim();
            const confirmPassword = confirmPasswordInput.value.trim();

            // Validaciones
            if (!password) {
                showMessage(formError, 'La nueva contrase√±a es requerida.');
                return;
            }

            if (!confirmPassword) {
                showMessage(formError, 'La confirmaci√≥n de contrase√±a es requerida.');
                return;
            }

            if (password !== confirmPassword) {
                showMessage(formError, 'Las contrase√±as no coinciden.');
                return;
            }

            const passwordValidation = validatePassword(password);
            if (!passwordValidation.valid) {
                showMessage(formError, passwordValidation.errors[0]);
                return;
            }

            // Iniciar loading
            appState.loading = true;
            submitBtn.disabled = true;
            submitBtn.textContent = 'üîÑ Restableciendo...';
            showMessage(formError, '', false);
            showMessage(successMessage, '', false);

            console.log('=== INICIANDO RESET DE CONTRASE√ëA ===');
            console.log('Token a usar:', appState.resetToken.substring(0, 20) + '...');

            try {
                const payload = {
                    token: appState.resetToken,
                    nuevaContrasena: password,
                    confirmarContrasena: confirmPassword
                };

                console.log('Enviando payload:', {
                    token: appState.resetToken.substring(0, 20) + '...',
                    nuevaContrasena: '[OCULTA]',
                    confirmarContrasena: '[OCULTA]'
                });

                const response = await fetch('https://checknote-27fe.onrender.com/api/v1/auth/reset-password', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                console.log('Respuesta - Status:', response.status);

                let data = {};
                try {
                    const responseText = await response.text();
                    console.log('Respuesta raw:', responseText);
                    
                    if (responseText) {
                        data = JSON.parse(responseText);
                        console.log('Respuesta parseada:', data);
                    }
                } catch (parseError) {
                    console.error('Error parseando respuesta:', parseError);
                }

                if (response.ok) {
                    console.log('‚úÖ Contrase√±a restablecida exitosamente');
                    showMessage(successMessage, '¬°Contrase√±a restablecida exitosamente! Redirigiendo al login...');
                    
                    // Limpiar formulario
                    passwordInput.value = '';
                    confirmPasswordInput.value = '';
                    strengthIndicator.style.display = 'none';
                    passwordMatch.style.display = 'none';
                    
                    // Redirigir despu√©s de 3 segundos
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 3000);
                    
                } else {
                    // Manejar errores espec√≠ficos
                    let errorMessage = 'Error al restablecer la contrase√±a';
                    
                    if (response.status === 400) {
                        errorMessage = data.message || 'Datos inv√°lidos. Verifique el token y las contrase√±as.';
                    } else if (response.status === 401) {
                        errorMessage = 'Token expirado o inv√°lido. Solicite un nuevo enlace.';
                        setTimeout(() => {
                            window.location.href = '/olvidar-password';
                        }, 3000);
                    } else if (response.status === 404) {
                        errorMessage = 'Token no encontrado. Solicite un nuevo enlace.';
                        setTimeout(() => {
                            window.location.href = '/olvidar-password';
                        }, 3000);
                    } else if (response.status >= 500) {
                        errorMessage = 'Error del servidor. Intente nuevamente m√°s tarde.';
                    } else {
                        errorMessage = data.message || `Error ${response.status}: ${response.statusText}`;
                    }
                    
                    console.log('‚ùå Error:', errorMessage);
                    showMessage(formError, errorMessage);
                }

            } catch (err) {
                console.error('Error en la petici√≥n:', err);
                
                let errorMessage = 'Error de conexi√≥n';
                if (err.name === 'TypeError' && err.message.includes('fetch')) {
                    errorMessage = 'Error de conexi√≥n. Verifique su internet y el estado del servidor.';
                } else if (err.message.includes('JSON')) {
                    errorMessage = 'Error procesando respuesta del servidor.';
                } else {
                    errorMessage = err.message || 'Error desconocido';
                }
                
                showMessage(formError, errorMessage);
            } finally {
                appState.loading = false;
                submitBtn.textContent = 'üîê Establecer Nueva Contrase√±a';
                validateForm();
            }
        });
    </script>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html>